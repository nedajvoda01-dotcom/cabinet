version: '3.8'

services:
  # Platform - Thin Core
  platform:
    image: php:8.2-apache
    container_name: cabinet-platform
    ports:
      - "${PLATFORM_PORT:-8080}:80"
    volumes:
      - ./platform:/var/www/html
      - ./registry:/app/registry
      - ./storage:/var/lib/cabinet/storage
      - ./platform/apache-config.conf:/etc/apache2/sites-available/000-default.conf
    environment:
      - STORAGE_PATH=/var/lib/cabinet/storage
      - REGISTRY_PATH=/app/registry
      - DEFAULT_RATE_LIMIT=${DEFAULT_RATE_LIMIT:-100}
      - DEFAULT_TIMEOUT=${DEFAULT_TIMEOUT:-30}
      - MAX_REQUEST_SIZE=${MAX_REQUEST_SIZE:-10485760}
      - DEV_MODE=${DEV_MODE:-true}
      - APP_ENV=${APP_ENV:-development}
      - ADAPTER_CAR_STORAGE_URL=http://adapter-car-storage
      - ADAPTER_PRICING_URL=http://adapter-pricing
      - ADAPTER_AUTOMATION_URL=http://adapter-automation
    command: >
      bash -c "
        a2enmod rewrite &&
        apache2-foreground
      "
    depends_on:
      - adapter-car-storage
      - adapter-pricing
      - adapter-automation

  # Adapters - Business Logic
  adapter-car-storage:
    image: php:8.2-apache
    container_name: cabinet-adapter-car-storage
    ports:
      - "8081:80"
    volumes:
      - ./adapters/car-storage:/var/www/html
    command: >
      bash -c "
        a2enmod rewrite &&
        apache2-foreground
      "

  adapter-pricing:
    image: php:8.2-apache
    container_name: cabinet-adapter-pricing
    ports:
      - "8082:80"
    volumes:
      - ./adapters/pricing:/var/www/html
    command: >
      bash -c "
        a2enmod rewrite &&
        apache2-foreground
      "

  adapter-automation:
    image: php:8.2-apache
    container_name: cabinet-adapter-automation
    ports:
      - "8083:80"
    volumes:
      - ./adapters/automation:/var/www/html
    command: >
      bash -c "
        a2enmod rewrite &&
        apache2-foreground
      "

  # UI - Admin
  ui-admin:
    image: nginx:alpine
    container_name: cabinet-ui-admin
    ports:
      - "${UI_ADMIN_PORT:-3000}:80"
    volumes:
      - ./ui/admin:/usr/share/nginx/html
    depends_on:
      - platform

  # UI - Public
  ui-public:
    image: nginx:alpine
    container_name: cabinet-ui-public
    ports:
      - "${UI_PUBLIC_PORT:-3001}:80"
    volumes:
      - ./ui/public:/usr/share/nginx/html
    depends_on:
      - platform

volumes:
  storage:
    driver: local
