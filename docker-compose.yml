# Phase 6.1: Network Isolation
# edge network: public access (platform + UI)
# mesh network: private adapter communication (platform + adapters only)
networks:
  edge:
    driver: bridge
  mesh:
    driver: bridge
    internal: false  # Allows adapters to make outbound calls if needed (e.g., external APIs)
                     # Adapter-to-adapter communication is prevented by architectural rules

services:
  # Platform - Thin Core
  # Connected to BOTH edge (for UI) and mesh (for adapters)
  platform:
    image: php:8.2-apache
    container_name: cabinet-platform
    ports:
      - "${PLATFORM_PORT:-8080}:80"
    networks:
      - edge
      - mesh
    volumes:
      - ./platform:/var/www/html
      - ./registry:/app/registry
      - ./storage:/var/lib/cabinet/storage
      - ./ui-unified:/var/www/html/ui
      - ./platform/apache-config.conf:/etc/apache2/sites-available/000-default.conf
    environment:
      - STORAGE_PATH=/var/lib/cabinet/storage
      - REGISTRY_PATH=/app/registry
      - DEFAULT_RATE_LIMIT=${DEFAULT_RATE_LIMIT:-100}
      - DEFAULT_TIMEOUT=${DEFAULT_TIMEOUT:-30}
      - MAX_REQUEST_SIZE=${MAX_REQUEST_SIZE:-10485760}
      - DEV_MODE=${DEV_MODE:-true}
      - APP_ENV=${APP_ENV:-development}
      - ADAPTER_CAR_STORAGE_URL=http://adapter-car-storage
      - ADAPTER_PRICING_URL=http://adapter-pricing
      - ADAPTER_AUTOMATION_URL=http://adapter-automation
      - ENABLE_AUTH=${ENABLE_AUTH:-true}
      - API_KEY_ADMIN=${API_KEY_ADMIN:-admin_secret_key_12345|admin|admin|admin_user}
      - API_KEY_PUBLIC=${API_KEY_PUBLIC:-public_secret_key_67890|public|guest|public_user}
    command: >
      bash -c "
        a2enmod rewrite &&
        apache2-foreground
      "
    depends_on:
      - adapter-car-storage
      - adapter-pricing
      - adapter-automation

  # Adapters - Business Logic
  # Connected ONLY to mesh (private network)
  # NO published ports (not accessible from outside)
  adapter-car-storage:
    image: php:8.2-apache
    container_name: cabinet-adapter-car-storage
    networks:
      - mesh
    expose:
      - "80"
    volumes:
      - ./adapters/car-storage:/var/www/html
    command: >
      bash -c "
        a2enmod rewrite &&
        apache2-foreground
      "

  adapter-pricing:
    image: php:8.2-apache
    container_name: cabinet-adapter-pricing
    networks:
      - mesh
    expose:
      - "80"
    volumes:
      - ./adapters/pricing:/var/www/html
    command: >
      bash -c "
        a2enmod rewrite &&
        apache2-foreground
      "

  adapter-automation:
    image: php:8.2-apache
    container_name: cabinet-adapter-automation
    networks:
      - mesh
    expose:
      - "80"
    volumes:
      - ./adapters/automation:/var/www/html
    command: >
      bash -c "
        a2enmod rewrite &&
        apache2-foreground
      "

  # UI - Unified Cabinet UI
  # Served directly by platform, no separate container needed
  # The unified UI is capability-aware and adapts based on user role

volumes:
  storage:
    driver: local
