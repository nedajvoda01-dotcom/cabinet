<!-- ======================================================================
     BLOCK 1) CARS PAGE MARKUP (NO LOCAL STYLES)
     NOTE: этот файл — чистый фрагмент без <html>/<body>, он встраивается через Pages.showPage
====================================================================== -->
<section class="cars-page" aria-label="Поиск автомобилей" data-cars-root>
  <div class="cars-shell">

    <div class="cars-panel">
      <div class="cars-hint ty-body">Найдите автомобили по параметрам и добавьте их в регионы.</div>

      <div class="cars-tabs-row">
        <div class="cars-tabs left-tabs" role="tablist" aria-label="Тип авто">
          <button class="cars-tab cars-tab--condition ty-body" data-condition="all" aria-pressed="true" type="button">Все</button>
          <button class="cars-tab cars-tab--condition ty-body" data-condition="used" aria-pressed="false" type="button">С пробегом</button>
          <button class="cars-tab cars-tab--condition ty-body" data-condition="new" aria-pressed="false" type="button">Новые</button>
        </div>

        <div class="cars-tabs right-tabs" role="tablist" aria-label="Статус объявления">
          <button class="cars-tab cars-tab--status ty-body" data-status="active" aria-pressed="true" type="button">Активные объявления</button>
          <button class="cars-tab cars-tab--status ty-body" data-status="removed" aria-pressed="false" type="button">Снятые объявления</button>
        </div>
      </div>

      <div class="cars-filters">
        <label class="cars-field cars-field--mark" data-label="Марка">
          <select class="cars-input ty-body" id="filterMark" aria-label="Марка"></select>
        </label>

        <label class="cars-field cars-field--model" data-label="Модель">
          <select class="cars-input ty-body" id="filterModel" aria-label="Модель"></select>
        </label>
      </div>

      <div class="cars-filters row-2">
        <label class="cars-field cars-field--year" data-label="Год">
          <select class="cars-input ty-body" id="filterYear" aria-label="Год"></select>
        </label>

        <label class="cars-field cars-field--color" data-label="Цвет">
          <input class="cars-input ty-body" type="text" id="filterColor" aria-label="Цвет" list="colorOptions" autocomplete="off" />
          <datalist id="colorOptions"></datalist>
        </label>

        <label class="cars-field cars-field--region" data-label="Регион">
          <select class="cars-input ty-body" id="filterRegion" aria-label="Регион"></select>
        </label>
      </div>

      <div class="cars-checkboxes">
        <label class="cars-check ty-body">
          <input class="cars-check-input" type="checkbox" name="available" checked />
          Доступные автомобили
        </label>
        <label class="cars-check ty-body">
          <input class="cars-check-input" type="checkbox" name="draft" />
          Черновики автомобилей
        </label>
        <label class="cars-check ty-body">
          <input class="cars-check-input" type="checkbox" name="ready" />
          Готовые автомобили
        </label>
      </div>

      <div class="cars-status ty-body" id="carsStatus" aria-live="polite">Загружаем данные…</div>

      <div class="cars-actions">
        <button class="cars-btn ghost ty-section" type="button" id="carsReset">Сбросить</button>
        <button class="cars-btn ty-section" type="button" id="carsShow" disabled>Показать 0 объявлений</button>
      </div>
    </div>

    <div class="cars-results" role="region" aria-label="Результаты поиска">
      <div class="cars-results-head">
        <div class="ty-section" id="sectorTitle">Активные объявления</div>
        <div class="ty-body cars-results-note">Выдача обновляется по кнопке “Показать”.</div>
      </div>
      <div class="cars-grid" id="carsGrid" aria-live="polite">
        <div class="ty-body cars-empty">Выбор фильтров не применён. Нажмите «Показать».</div>
      </div>
    </div>

  </div>

  <div class="cars-modal" id="carsModal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Детали объявления">
    <div class="cars-modal-backdrop" data-modal-close></div>
    <div class="cars-modal-card" role="document">
      <div class="cars-modal-head">
        <div class="cars-modal-title ty-title" id="carsModalTitle"></div>
        <button class="cars-modal-close ty-section" type="button" data-modal-close aria-label="Закрыть">Закрыть</button>
      </div>
      <div class="cars-modal-body">
        <div class="cars-modal-media" id="carsModalMedia"></div>
        <div class="cars-modal-info">
          <div class="cars-modal-price ty-title" id="carsModalPrice"></div>
          <div class="cars-modal-sub ty-body" id="carsModalSub"></div>
          <ul class="cars-modal-list ty-body" id="carsModalList"></ul>
          <a class="cars-btn ty-section cars-modal-link" id="carsModalLink" target="_blank" rel="noopener">Перейти к объявлению</a>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
/* ======================================================================
   BLOCK 2) CARS CONSTS / CONFIG
====================================================================== */
const CSV_SOURCES = {
  active: [
    "data/active/autoru_car_active.csv",
    "data/active/autoru_car_active2.csv",
    "data/active/autoru_car_active3.csv",
  ],
  removed: [
    "data/removed/autoru_car_removed.csv",
    "data/removed/autoru_car_removed2.csv",
    "data/removed/autoru_car_removed3.csv",
  ],
};

const EXCLUDED_DETAILS = new Set([
  "image_urls",
]);

/* ======================================================================
   BLOCK 3) CARS STATE + ELEMENTS
====================================================================== */
const state = {
  allCarsActive: [],
  allCarsRemoved: [],
  filtered: [],
  condition: "all",
  status: "active",
  filters: {
    mark: null,
    model: null,
    year: null,
    color: null,
    region: null,
  },
  lastSignatures: {
    active: null,
    removed: null,
  },
};

const elements = {
  root: document.querySelector("[data-cars-root]"),
  status: document.getElementById("carsStatus"),
  tabsCondition: [...document.querySelectorAll("[data-condition]")],
  tabsStatus: [...document.querySelectorAll("[data-status]")],
  selectMark: document.getElementById("filterMark"),
  selectModel: document.getElementById("filterModel"),
  selectYear: document.getElementById("filterYear"),
  selectColor: document.getElementById("filterColor"),
  colorList: document.getElementById("colorOptions"),
  selectRegion: document.getElementById("filterRegion"),
  resetBtn: document.getElementById("carsReset"),
  showBtn: document.getElementById("carsShow"),
  grid: document.getElementById("carsGrid"),
  sectorTitle: document.getElementById("sectorTitle"),
  fields: [...document.querySelectorAll(".cars-field")],
  modal: document.getElementById("carsModal"),
  modalTitle: document.getElementById("carsModalTitle"),
  modalMedia: document.getElementById("carsModalMedia"),
  modalPrice: document.getElementById("carsModalPrice"),
  modalSub: document.getElementById("carsModalSub"),
  modalList: document.getElementById("carsModalList"),
  modalLink: document.getElementById("carsModalLink"),
};

/* ======================================================================
   BLOCK 4) CARS DOMAIN: CLEAN / NORMALIZE / PARSE
====================================================================== */
function cleanValue(v) {
  if (v === undefined || v === null) return null;
  const str = String(v).trim();
  if (!str) return null;
  const lower = str.toLowerCase();
  if (["nan", "null", "undefined"].includes(lower)) return null;
  return str;
}

function normalizeLower(v) {
  const val = cleanValue(v);
  return val ? val.toLowerCase() : null;
}

function parseNumber(value) {
  const digits = cleanValue(value)?.replace(/[^0-9-]/g, "");
  if (!digits) return null;
  const num = Number(digits);
  return Number.isFinite(num) ? num : null;
}

function parseDate(value) {
  const v = cleanValue(value);
  if (!v) return null;
  const d = new Date(v);
  return Number.isFinite(d.getTime()) ? d : null;
}

function detectDelimiter(text) {
  const firstLine = text.split(/\r?\n/)[0] || "";
  const countSemicolon = (firstLine.match(/;/g) || []).length;
  const countComma = (firstLine.match(/,/g) || []).length;
  if (countSemicolon > countComma) return ";";
  if (countComma > countSemicolon) return ",";
  return ",";
}

function safeSplit(line, delimiter) {
  const parts = [];
  let current = "";
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      inQuotes = !inQuotes;
      current += ch;
      continue;
    }
    if (ch === delimiter && !inQuotes) {
      parts.push(current);
      current = "";
      continue;
    }
    current += ch;
  }
  parts.push(current);
  return parts.map(p => p.replace(/^"|"$/g, ""));
}

function hashSignature(lines) {
  const body = lines.slice(1).join("\n");
  let hash = 0;
  for (let i = 0; i < body.length; i++) {
    hash = (hash * 31 + body.charCodeAt(i)) >>> 0;
  }
  return hash;
}

function parseCsv(text) {
  const delimiter = detectDelimiter(text);
  const lines = text.split(/\r?\n/).filter(Boolean);
  if (!lines.length) return { rows: [], signature: null };

  const header = safeSplit(lines[0], delimiter).map(cleanValue);
  const rows = lines.slice(1).map(line => {
    const parts = safeSplit(line, delimiter).map(cleanValue);
    const row = {};
    header.forEach((key, idx) => {
      row[key ?? idx] = parts[idx] ?? null;
    });
    return row;
  });

  return { rows, signature: hashSignature(lines) };
}

/* ======================================================================
   BLOCK 5) CARS INFRA: FETCH / CACHE
====================================================================== */
async function fetchCsv(url) {
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`CSV fetch failed: ${url}`);
  return res.text();
}

async function loadCsvGroup(urls) {
  const results = await Promise.all(urls.map(async (url) => {
    try {
      const text = await fetchCsv(url);
      return { ok: true, url, text };
    } catch (e) {
      console.error(e);
      return { ok: false, url, text: null };
    }
  }));

  const okResults = results.filter(r => r.ok && r.text);
  return okResults.length ? okResults.map(r => r.text).join("\n") : null;
}

async function loadAllCsv() {
  const [activeText, removedText] = await Promise.all([
    loadCsvGroup(CSV_SOURCES.active),
    loadCsvGroup(CSV_SOURCES.removed),
  ]);

  return { activeText, removedText };
}

/* ======================================================================
   BLOCK 6) CARS APP: DATA + FILTERS
====================================================================== */
function normalizeCar(car) {
  return {
    ...car,
    brand: cleanValue(car.brand),
    model: cleanValue(car.model),
    year: parseNumber(car.year),
    color: normalizeLower(car.color),
    region: cleanValue(car.region),
    url: cleanValue(car.url),
    price: cleanValue(car.price),
    created_at: parseDate(car.created_at),
  };
}

function splitCars(rows) {
  const active = [];
  const removed = [];
  rows.forEach((row) => {
    const normalized = normalizeCar(row);
    if (normalized.status === "removed") {
      removed.push(normalized);
    } else {
      active.push(normalized);
    }
  });
  return { active, removed };
}

function mapFilters(cars) {
  const marks = new Set();
  const models = new Set();
  const years = new Set();
  const colors = new Set();
  const regions = new Set();

  cars.forEach((car) => {
    if (car.brand) marks.add(car.brand);
    if (car.model) models.add(car.model);
    if (car.year) years.add(car.year);
    if (car.color) colors.add(car.color);
    if (car.region) regions.add(car.region);
  });

  return {
    marks: [...marks].sort(),
    models: [...models].sort(),
    years: [...years].sort((a, b) => b - a),
    colors: [...colors].sort(),
    regions: [...regions].sort(),
  };
}

function applyFilters(list, condition, filters) {
  return list.filter((car) => {
    if (condition === "used" && car.condition !== "used") return false;
    if (condition === "new" && car.condition !== "new") return false;
    if (filters.mark && car.brand !== filters.mark) return false;
    if (filters.model && car.model !== filters.model) return false;
    if (filters.year && car.year !== Number(filters.year)) return false;
    if (filters.color) {
      const c = normalizeLower(car.color);
      if (c !== normalizeLower(filters.color)) return false;
    }
    if (filters.region && car.region !== filters.region) return false;
    return true;
  });
}

function describeCar(car) {
  const year = car.year ? `${car.year}` : "—";
  const color = car.color ? car.color : "—";
  const region = car.region ? car.region : "Регион не указан";
  return `${car.brand ?? "Без марки"} • ${car.model ?? "Без модели"} • ${year} • ${color} • ${region}`;
}

function formatPrice(v) {
  const num = parseNumber(v);
  if (!num) return "Цена не указана";
  return `${num.toLocaleString("ru-RU")} ₽`;
}

function toCard(car) {
  const details = [];
  Object.entries(car).forEach(([key, value]) => {
    if (EXCLUDED_DETAILS.has(key)) return;
    if (value === null || value === undefined || value === "") return;
    if (["brand", "model", "year", "color", "region", "url", "condition", "status", "price"].includes(key)) return;
    details.push(`${key}: ${value}`);
  });

  return {
    id: car.id ?? `${car.brand}-${car.model}-${car.year}-${car.region}-${car.url ?? ""}`,
    title: car.brand && car.model ? `${car.brand} ${car.model}` : car.brand || car.model || "Без названия",
    price: formatPrice(car.price),
    sub: describeCar(car),
    details,
    url: car.url,
    condition: car.condition,
    status: car.status,
  };
}

function buildCards(cars) {
  return cars.map(toCard);
}

function countByCondition(cars, condition) {
  if (condition === "all") return cars.length;
  return cars.filter(car => car.condition === condition).length;
}

function computeShowCount(condition) {
  const list = state.status === "active" ? state.allCarsActive : state.allCarsRemoved;
  const filtered = applyFilters(list, condition, state.filters);
  return filtered.length;
}

/* ======================================================================
   BLOCK 7) CARS VIEW HELPERS
====================================================================== */
function setStatus(text) {
  elements.status.textContent = text;
}

function setTabsPressed(group, activeValue, attr) {
  group.forEach((btn) => {
    const isActive = btn.getAttribute(attr) === activeValue;
    btn.setAttribute("aria-pressed", isActive ? "true" : "false");
  });
}

function fillSelect(select, options, placeholder) {
  select.innerHTML = "";
  if (placeholder) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = placeholder;
    select.appendChild(opt);
  }
  options.forEach((item) => {
    const opt = document.createElement("option");
    opt.value = String(item);
    opt.textContent = String(item);
    select.appendChild(opt);
  });
}

function fillColorList(colors) {
  elements.colorList.innerHTML = "";
  colors.forEach((color) => {
    const opt = document.createElement("option");
    opt.value = color;
    elements.colorList.appendChild(opt);
  });
}

function renderCards(cards) {
  elements.grid.innerHTML = "";
  if (!cards.length) {
    const empty = document.createElement("div");
    empty.className = "ty-body cars-empty";
    empty.textContent = "Нет объявлений по выбранным фильтрам.";
    elements.grid.appendChild(empty);
    return;
  }

  const frag = document.createDocumentFragment();
  cards.forEach((card) => {
    const el = document.createElement("div");
    el.className = "cars-card";
    el.tabIndex = 0;
    el.dataset.cardId = card.id;

    const title = document.createElement("div");
    title.className = "cars-card-title";
    title.textContent = card.title;

    const price = document.createElement("div");
    price.className = "ty-body";
    price.textContent = card.price;

    const sub = document.createElement("div");
    sub.className = "cars-card-sub";
    sub.textContent = card.sub;

    const more = document.createElement("div");
    more.className = "ty-body";
    more.textContent = "Подробнее…";

    el.append(title, price, sub, more);
    frag.appendChild(el);
  });

  elements.grid.appendChild(frag);
}

function updateShowCount() {
  const count = computeShowCount(state.condition);
  elements.showBtn.textContent = `Показать ${count} объявлений`;
  elements.showBtn.disabled = count === 0;
}

function updateFilterOptions() {
  const source = state.status === "active" ? state.allCarsActive : state.allCarsRemoved;

  const markFiltered = applyFilters(source, state.condition, { ...state.filters, mark: null });
  const modelFiltered = applyFilters(source, state.condition, { ...state.filters, model: null });
  const yearFiltered = applyFilters(source, state.condition, { ...state.filters, year: null });
  const colorFiltered = applyFilters(source, state.condition, { ...state.filters, color: null });
  const regionFiltered = applyFilters(source, state.condition, { ...state.filters, region: null });

  const markOptions = mapFilters(markFiltered).marks;
  const modelOptions = mapFilters(modelFiltered).models;
  const yearOptions = mapFilters(yearFiltered).years;
  const colorOptions = mapFilters(colorFiltered).colors;
  const regionOptions = mapFilters(regionFiltered).regions;

  fillSelect(elements.selectMark, markOptions, "Марка");
  fillSelect(elements.selectModel, modelOptions, "Модель");
  fillSelect(elements.selectYear, yearOptions, "Год");
  fillSelect(elements.selectRegion, regionOptions, "Регион");
  fillColorList(colorOptions);

  if (state.filters.mark && markOptions.includes(state.filters.mark)) {
    elements.selectMark.value = state.filters.mark;
  } else {
    elements.selectMark.value = "";
    state.filters.mark = null;
  }

  if (state.filters.model && modelOptions.includes(state.filters.model)) {
    elements.selectModel.value = state.filters.model;
  } else {
    elements.selectModel.value = "";
    state.filters.model = null;
  }

  if (state.filters.year && yearOptions.includes(Number(state.filters.year))) {
    elements.selectYear.value = state.filters.year;
  } else {
    elements.selectYear.value = "";
    state.filters.year = null;
  }

  if (state.filters.region && regionOptions.includes(state.filters.region)) {
    elements.selectRegion.value = state.filters.region;
  } else {
    elements.selectRegion.value = "";
    state.filters.region = null;
  }

  updateFieldLabels();
}

function setSectorTitle(status) {
  elements.sectorTitle.textContent = status === "active" ? "Активные объявления" : "Снятые объявления";
}

function updateFieldLabels() {
  elements.fields.forEach((field) => {
    const input = field.querySelector(".cars-input");
    if (!input) return;
    const hasValue = input.value && input.value.trim().length > 0;
    field.classList.toggle("has-value", hasValue);
  });
}

function openModal(card) {
  if (!card) return;
  elements.modalTitle.textContent = card.title;
  elements.modalPrice.textContent = card.price;
  elements.modalSub.textContent = card.sub;
  elements.modalList.innerHTML = "";

  card.details.forEach((item) => {
    const li = document.createElement("li");
    li.textContent = item;
    elements.modalList.appendChild(li);
  });

  if (card.url) {
    elements.modalLink.href = card.url;
    elements.modalLink.style.display = "inline-flex";
  } else {
    elements.modalLink.removeAttribute("href");
    elements.modalLink.style.display = "none";
  }

  elements.modal.setAttribute("aria-hidden", "false");
  elements.modal.classList.add("is-open");
}

function closeModal() {
  elements.modal.setAttribute("aria-hidden", "true");
  elements.modal.classList.remove("is-open");
}

/* ======================================================================
   BLOCK 8) CARS CONTROLLERS / EVENTS
====================================================================== */
function bindTabs() {
  elements.tabsCondition.forEach((btn) => {
    btn.addEventListener("click", () => {
      const value = btn.getAttribute("data-condition");
      state.condition = value;
      setTabsPressed(elements.tabsCondition, value, "data-condition");
      updateFilterOptions();
      updateShowCount();
    });
  });

  elements.tabsStatus.forEach((btn) => {
    btn.addEventListener("click", () => {
      const value = btn.getAttribute("data-status");
      state.status = value;
      setTabsPressed(elements.tabsStatus, value, "data-status");
      setSectorTitle(value);
      updateFilterOptions();
      updateShowCount();
    });
  });
}

function bindFilters() {
  elements.selectMark.addEventListener("change", () => {
    state.filters.mark = elements.selectMark.value || null;
    updateFilterOptions();
    updateShowCount();
  });

  elements.selectModel.addEventListener("change", () => {
    state.filters.model = elements.selectModel.value || null;
    updateFilterOptions();
    updateShowCount();
  });

  elements.selectYear.addEventListener("change", () => {
    state.filters.year = elements.selectYear.value || null;
    updateFilterOptions();
    updateShowCount();
  });

  elements.selectColor.addEventListener("input", () => {
    state.filters.color = elements.selectColor.value || null;
    updateShowCount();
    updateFieldLabels();
  });

  elements.selectRegion.addEventListener("change", () => {
    state.filters.region = elements.selectRegion.value || null;
    updateFilterOptions();
    updateShowCount();
  });

  elements.fields.forEach((field) => {
    const input = field.querySelector(".cars-input");
    if (!input) return;
    input.addEventListener("change", updateFieldLabels);
    input.addEventListener("input", updateFieldLabels);
  });
}

function bindActions() {
  elements.resetBtn.addEventListener("click", () => {
    state.filters = { mark: null, model: null, year: null, color: null, region: null };
    elements.selectMark.value = "";
    elements.selectModel.value = "";
    elements.selectYear.value = "";
    elements.selectColor.value = "";
    elements.selectRegion.value = "";
    updateFieldLabels();
    updateFilterOptions();
    updateShowCount();
  });

  elements.showBtn.addEventListener("click", () => {
    const source = state.status === "active" ? state.allCarsActive : state.allCarsRemoved;
    const filtered = applyFilters(source, state.condition, state.filters);
    state.filtered = filtered;
    renderCards(buildCards(filtered));
  });
}

function bindModal() {
  elements.grid.addEventListener("click", (e) => {
    const cardEl = e.target.closest(".cars-card");
    if (!cardEl) return;
    const id = cardEl.dataset.cardId;
    const card = state.filtered.find(c => c.id === id);
    openModal(card);
  });

  elements.grid.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const cardEl = e.target.closest(".cars-card");
      if (!cardEl) return;
      const id = cardEl.dataset.cardId;
      const card = state.filtered.find(c => c.id === id);
      openModal(card);
    }
  });

  elements.modal.addEventListener("click", (e) => {
    if (e.target.hasAttribute("data-modal-close")) {
      closeModal();
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && elements.modal.classList.contains("is-open")) {
      closeModal();
    }
  });
}

/* ======================================================================
   BLOCK 9) CARS INIT
====================================================================== */
async function init() {
  if (!elements.root) return;

  bindTabs();
  bindFilters();
  bindActions();
  bindModal();
  updateFieldLabels();

  setStatus("Загружаем данные…");
  const { activeText, removedText } = await loadAllCsv();

  const parsedActive = activeText ? parseCsv(activeText) : { rows: [], signature: null };
  const parsedRemoved = removedText ? parseCsv(removedText) : { rows: [], signature: null };

  state.lastSignatures.active = parsedActive.signature;
  state.lastSignatures.removed = parsedRemoved.signature;

  const { active, removed } = splitCars([...parsedActive.rows, ...parsedRemoved.rows]);
  state.allCarsActive = active;
  state.allCarsRemoved = removed;

  updateFilterOptions();

  updateShowCount();
  setStatus("Данные загружены. Нажмите «Показать».");
}

init();
</script>
