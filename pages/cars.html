<!-- pages/cars.html  ✅ ФРАГМЕНТ, НЕ ПОЛНЫЙ HTML-ДОКУМЕНТ -->
<section class="cars-page" aria-label="Поиск автомобилей" data-cars-root>
  <style>
    /* =========================================================
      TOKENS / SPACING — 1:1 по макету
    ========================================================= */
    :root{
      --cars-h: 32px;          /* единая высота всей UI */
      --cars-gap: 8px;        /* единый хор. gap */
      --cars-row-gap: 10px;   /* между рядами */
      --cars-pad-x: 12px;
      --cars-pad-y: 12px;
    }

    .cars-page{
      width:100%;
      display:flex;
      justify-content:center;
      padding: 22px 24px 28px;
    }
    .cars-shell{
      width:100%;
      max-width: 980px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* =========================================================
      FILTERS (внешняя капсула меню)
    ========================================================= */
    .cars-filters{
      background: var(--c-white);
      border: 1px solid var(--c-gray-light);
      border-radius: 16px;
      padding: var(--cars-pad-y) var(--cars-pad-x);
      display:flex;
      flex-direction:column;
      gap: var(--cars-row-gap);
      box-shadow: 0 4px 16px rgba(0,0,0,.04); /* легкая "дымка" */
    }

    /* Ряды таблеток сверху */
    .cars-tabs-row{
      display:flex;
      gap: var(--cars-gap);
      flex-wrap:wrap;
      align-items:center;
    }

    /* КАПСУЛЫ-ТАБЫ */
    .cars-tabs{
      display:flex;
      border:1px solid var(--c-gray-light);
      border-radius: 999px;
      background: var(--c-white);
      overflow:hidden;
      height: var(--cars-h);
    }
    .cars-tab{
      border:none;
      background: var(--c-white);
      color: var(--c-gray);
      padding: 0 14px;
      cursor:pointer;
      transition: background 120ms ease, color 120ms ease;
      font: inherit;
      line-height: var(--lh-ui);
      letter-spacing: var(--ls-ui);
      font-size: var(--fs-12);
      font-weight: var(--fw-menu);
      white-space:nowrap;
      height: var(--cars-h);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cars-tab + .cars-tab{
      border-left:1px solid var(--c-gray-light);
    }
    .cars-tab[aria-pressed="true"]{
      background: var(--c-gray);
      color: var(--c-white);
    }
    .cars-tab:hover{
      background: var(--c-gray-light);
      color: var(--c-black);
    }

    /* =========================================================
      НИЖНИЕ ПОЛЯ — контейнеры
    ========================================================= */
    .cars-controls{
      display:flex;
      flex-direction:column;
      gap: var(--cars-row-gap);
    }

    .cars-selects{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: var(--cars-gap);
    }
    @media (max-width: 980px){
      .cars-selects{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (max-width: 640px){
      .cars-selects{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 420px){
      .cars-selects{ grid-template-columns: 1fr; }
    }

    .cars-field{
      position:relative;
      display:flex;
      align-items:center;
      background: var(--c-white);
      border:1px solid var(--c-gray-light);
      border-radius: 8px;
      height: var(--cars-h);
      min-height: var(--cars-h);
      padding: 0 10px;
      transition: border 120ms ease, background 120ms ease;
      width:100%;
    }

    /* label внутри поля */
    .cars-field::before{
      content: attr(data-label);
      position:absolute;
      left:10px;
      top:6px;
      font-size: var(--fs-11);
      font-weight: var(--fw-menu);
      letter-spacing: var(--ls-ui);
      color: var(--c-gray-light);
      pointer-events:none;
      opacity:1;
    }

    /* выбранное поле = серый фон + белый текст */
    .cars-field.has-value{
      background: var(--c-gray);
      border-color: var(--c-gray);
    }
    .cars-field.has-value::before{
      color: var(--c-white);
      opacity:.9;
    }

    /* select без нативных стрелок */
    .cars-input{
      width:100%;
      height: var(--cars-h);
      border:none;
      outline:none;
      background:transparent;
      padding: 12px 26px 0 0;  /* место под label и стрелку */
      font-size: var(--fs-13);
      font-weight: var(--fw-menu);
      line-height: var(--lh-ui);
      color: var(--c-black);
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      cursor:pointer;
    }
    .cars-field.has-value .cars-input{
      color: var(--c-white);
    }
    .cars-input::-ms-expand{ display:none; }
    .cars-input::-webkit-search-cancel-button{ display:none; }
    .cars-input::-webkit-clear-button{ display:none; }

    /* наша стрелка */
    .cars-field::after{
      content:"";
      position:absolute;
      right:10px;
      top:50%;
      transform: translateY(-20%);
      width:0;height:0;
      border-left:4px solid transparent;
      border-right:4px solid transparent;
      border-top:6px solid var(--c-gray);
      pointer-events:none;
    }
    .cars-field.has-value::after{
      border-top-color: var(--c-white);
    }

    /* опции (макс приближение к теме) */
    .cars-input option,
    .cars-input optgroup{
      background: var(--c-white);
      color: var(--c-black);
      font-weight: var(--fw-regular);
    }
    .cars-input option:checked{
      background: var(--c-black);
      color: var(--c-white);
    }

    /* =========================================================
      ДЕЙСТВИЯ СПРАВА — одинаковая высота и выплывание
    ========================================================= */
    .cars-actions-outside{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: var(--cars-gap);
      margin-top:4px;
      transition: transform 180ms ease, opacity 180ms ease;
    }
    .cars-actions-outside.is-loading{
      opacity:0;
      transform: translateY(-6px);
      pointer-events:none;
    }

    .cars-btn{
      border-radius: 8px;
      padding: 7px 12px 6px;
      border:1px solid var(--c-gray-light);
      background: var(--c-white);
      cursor:pointer;
      font-size: var(--fs-12);
      font-weight: var(--fw-menu);
      letter-spacing: var(--ls-ui);
      transition: background 120ms ease, border 120ms ease, color 120ms ease, opacity 120ms ease;
      color: var(--c-gray);
      height: var(--cars-h);
      display:inline-flex;
      align-items:center;
      white-space:nowrap;
    }
    .cars-btn:hover{
      background: var(--c-gray-light);
      border-color: var(--c-gray);
      color: var(--c-black);
    }
    .cars-btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .cars-btn--show{
      background: var(--c-black);
      color: var(--c-white);
      border-color: var(--c-black);
    }
    .cars-btn--show:hover{
      background: var(--c-gray-dark);
      border-color: var(--c-gray-dark);
      color: var(--c-white);
    }

    /* =========================================================
      RESULTS — без общей капсулы и заголовков
    ========================================================= */
    .cars-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height: 40px;
      padding: 2px 0 0;
    }
    .cars-card{
      border:1px solid var(--c-gray-light);
      border-radius:12px;
      background: var(--c-white);
      padding: 10px 12px;
      cursor:pointer;
      transition: background 120ms ease, border 120ms ease, transform 120ms ease;
    }
    .cars-card:hover{
      background:#fafafa;
      border-color:#d7d7d7;
      transform: translateY(-1px);
    }
    .cars-card-title{
      font-size: var(--fs-15);
      font-weight: var(--fw-semibold);
      line-height: var(--lh-snug);
      color: var(--c-black);
    }
    .cars-card-sub{
      margin-top:3px;
      font-size: var(--fs-13);
      font-weight: var(--fw-regular);
      line-height: var(--lh-normal);
      color: var(--c-gray);
    }
    .cars-empty{
      color: var(--c-gray);
      padding: 6px 2px;
      font-size: var(--fs-13);
    }

    /* =========================================================
      MODAL
    ========================================================= */
    .cars-modal{
      position:fixed;
      inset:0;
      display:none;
      z-index:999;
    }
    .cars-modal.is-open{ display:block; }

    .cars-modal-backdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,.55);
    }
    .cars-modal-card{
      position:relative;
      margin: 5vh auto 0;
      width: min(900px, 95vw);
      background: var(--c-white);
      border-radius: 16px;
      padding: 14px;
      border:1px solid var(--c-gray-light);
    }
    .cars-modal-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding: 4px 4px 8px;
      border-bottom:1px solid #eee;
    }
    .cars-modal-title{
      font-size: var(--fs-24);
      font-weight: var(--fw-semibold);
      line-height: var(--lh-snug);
      color: var(--c-black);
    }
    .cars-modal-close{
      border:none; background:transparent; cursor:pointer;
      font-size: var(--fs-12);
      font-weight: var(--fw-menu);
      color: var(--c-gray);
      padding:6px 8px;
      border-radius:8px;
    }
    .cars-modal-close:hover{ background:#f2f2f2; }

    .cars-modal-body{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
      padding: 10px 4px 4px;
    }
    @media (max-width: 700px){
      .cars-modal-body{ grid-template-columns: 1fr; }
    }

    .cars-modal-media{
      border-radius: 12px;
      border:1px solid #eee;
      min-height: 220px;
      display:grid; place-items:center;
      overflow:hidden;
      background:#fff;
    }
    .cars-modal-media img{
      width:100%; height:100%; object-fit:cover;
      display:block;
    }

    .cars-modal-price{
      font-size: var(--fs-24);
      font-weight: var(--fw-semibold);
      margin-bottom:4px;
      color: var(--c-black);
    }
    .cars-modal-sub{
      color: var(--c-gray);
      margin-bottom:8px;
      font-size: var(--fs-13);
    }
    .cars-modal-list{
      list-style:none;
      padding-left:0;
      display:grid; gap:4px;
      font-size: var(--fs-13);
      color: var(--c-black);
    }
    .cars-modal-link{
      display:inline-flex;
      margin-top:10px;
      text-decoration:none;
      background: var(--c-black);
      color: var(--c-white);
      border-radius:10px;
      padding: 7px 10px 6px;
      font-size: var(--fs-12);
      font-weight: var(--fw-menu);
      letter-spacing: var(--ls-ui);
      width: fit-content;
    }
  </style>

  <div class="cars-shell">
    <!-- FILTERS -->
    <div class="cars-filters" role="region" aria-label="Фильтры поиска">

      <!-- row 1: статус / состояние / продавец -->
      <div class="cars-tabs-row">
        <div class="cars-tabs cars-tabs--status" role="tablist" aria-label="Статус объявления">
          <button class="cars-tab cars-tab--status" data-status="removed" aria-pressed="false" type="button">Снятые объявления</button>
          <button class="cars-tab cars-tab--status" data-status="active" aria-pressed="true" type="button">Активные объявления</button>
        </div>

        <div class="cars-tabs cars-tabs--condition" role="tablist" aria-label="Тип авто">
          <button class="cars-tab cars-tab--condition" data-condition="all" aria-pressed="true" type="button">Все</button>
          <button class="cars-tab cars-tab--condition" data-condition="used" aria-pressed="false" type="button">С пробегом</button>
          <button class="cars-tab cars-tab--condition" data-condition="new" aria-pressed="false" type="button">Новые</button>
        </div>

        <div class="cars-tabs cars-tabs--seller" role="tablist" aria-label="Продавец">
          <button class="cars-tab cars-tab--seller" data-seller="all" aria-pressed="true" type="button">Все</button>
          <button class="cars-tab cars-tab--seller" data-seller="owner" aria-pressed="false" type="button">Собственник</button>
          <button class="cars-tab cars-tab--seller" data-seller="dealer" aria-pressed="false" type="button">Дилер</button>
        </div>
      </div>

      <!-- row 2: selects -->
      <div class="cars-controls">
        <div class="cars-selects">
          <div class="cars-field" data-label="Марка" data-field="mark">
            <select class="cars-input ty-body" id="filterMark" aria-label="Марка"></select>
          </div>

          <div class="cars-field" data-label="Модель" data-field="model">
            <select class="cars-input ty-body" id="filterModel" aria-label="Модель"></select>
          </div>

          <div class="cars-field" data-label="Год" data-field="year">
            <select class="cars-input ty-body" id="filterYear" aria-label="Год"></select>
          </div>

          <div class="cars-field" data-label="Цвет" data-field="color">
            <select class="cars-input ty-body" id="filterColor" aria-label="Цвет"></select>
          </div>

          <div class="cars-field" data-label="Регион" data-field="region">
            <select class="cars-input ty-body" id="filterRegion" aria-label="Регион"></select>
          </div>
        </div>

        <!-- actions -->
        <div class="cars-actions-outside is-loading" id="carsActions">
          <button class="cars-btn cars-btn--reset ty-section" type="button" id="carsReset">Сбросить</button>
          <button class="cars-btn cars-btn--show ty-section" type="button" id="carsShow" disabled>Найдено 0 объявлений</button>
        </div>
      </div>
    </div>

    <!-- RESULTS -->
    <div class="cars-grid" id="carsGrid" aria-live="polite"></div>
  </div>

  <!-- MODAL -->
  <div class="cars-modal" id="carsModal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Детали объявления">
    <div class="cars-modal-backdrop" data-modal-close></div>
    <div class="cars-modal-card" role="document">
      <div class="cars-modal-head">
        <div class="cars-modal-title ty-title" id="carsModalTitle"></div>
        <button class="cars-modal-close ty-section" type="button" data-modal-close aria-label="Закрыть">Закрыть</button>
      </div>
      <div class="cars-modal-body">
        <div class="cars-modal-media" id="carsModalMedia"></div>
        <div class="cars-modal-info">
          <div class="cars-modal-price ty-title" id="carsModalPrice"></div>
          <div class="cars-modal-sub ty-body" id="carsModalSub"></div>
          <ul class="cars-modal-list ty-body" id="carsModalList"></ul>
          <a class="cars-modal-link ty-section" id="carsModalLink" target="_blank" rel="noopener">Перейти к объявлению</a>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* =========================================================
     CONFIG: multiple CSV per kind + hourly sync + dedupe
  ========================================================= */
  const CSV_SOURCES = {
    active: [
      "data/active/autoru_car_active.csv",
      "data/active/autoru_car_active2.csv",
      "data/active/autoru_car_active3.csv",
    ],
    removed: [
      "data/removed/autoru_car_removed.csv",
      "data/removed/autoru_car_removed2.csv",
      "data/removed/autoru_car_removed3.csv",
    ],
  };
  const UPDATE_INTERVAL_MS = 60 * 60 * 1000;
  const EXCLUDED_DETAILS = new Set(["image_urls"]);

  /* =========================================================
     VALIDATION LISTS
  ========================================================= */
  const VALID_REGIONS = [
    "москва","московская область","санкт-петербург","ленинградская область",
    "краснодарский край","ростовская область","воронежская область","самарская область",
    "татарстан","свердловская область","нижегородская область","пермский край",
    "новосибирская область","красноярский край","челябинская область","омская область",
    "приморский край","хабаровский край","иркутская область","алтайский край",
    "ставропольский край","башкортостан","удмуртия","тюменская область",
    // ... (можешь расширять при необходимости)
  ].map(s=>s.toLowerCase());

  const MOSCOW_AO = [
    "цао","сзао","свао","вао","ювао","юао","юзао","зао","сао","тинaо","троицкий","новомосковский"
  ].map(s=>s.toLowerCase());

  const DEALER_HINTS = [
    "рольф","автодом","major","мейджор","авилон","fresh","исток","транс","автоцентр",
    "ооо","ао","зао","ип ","dealer","trade","group","motors","cars","auto"
  ].map(s=>s.toLowerCase());

  /* =========================================================
     TRANSLATION MAP for UI
  ========================================================= */
  const FIELD_RU = {
    id: "Айди объявления",
    inner_id: "Внутренний айди",
    mark: "Марка",
    model: "Модель",
    generation: "Поколение",
    configuration: "Кузов",
    complectation: "Комплектация",
    url: "Ссылка",
    price_rub: "Цена (₽)",
    price_usd: "Цена ($)",
    price_eur: "Цена (€)",
    year: "Год",
    color: "Цвет",
    wheel: "Руль",
    vin: "VIN",
    owners_count: "Владельцев",
    section: "Раздел",
    condition: "Состояние",
    in_stock: "В наличии",
    custom: "Особое",
    km_age: "Пробег",
    region: "Регион",
    city: "Город",
    seller: "Продавец",
    account_id: "Айди аккаунта",
  };

  /* =========================================================
     STATE + ELEMENTS
  ========================================================= */
  const state = {
    allCarsActive: [],
    allCarsRemoved: [],
    filtered: [],
    condition: "all",
    status: "active",
    sellerType: "all", // all | owner | dealer
    filters: { mark:null, model:null, year:null, color:null, region:null },
    lastSignatures: { active:null, removed:null },
    lastRenderKind: "active",
    isBooted: false,
  };

  const elements = {
    root: document.querySelector("[data-cars-root]"),
    tabsCondition: [...document.querySelectorAll("[data-condition]")],
    tabsStatus: [...document.querySelectorAll("[data-status]")],
    tabsSeller: [...document.querySelectorAll("[data-seller]")],
    selectMark: document.getElementById("filterMark"),
    selectModel: document.getElementById("filterModel"),
    selectYear: document.getElementById("filterYear"),
    selectColor: document.getElementById("filterColor"),
    selectRegion: document.getElementById("filterRegion"),
    resetBtn: document.getElementById("carsReset"),
    showBtn: document.getElementById("carsShow"),
    actions: document.getElementById("carsActions"),
    grid: document.getElementById("carsGrid"),
    fields: [...document.querySelectorAll(".cars-field")],
    modal: document.getElementById("carsModal"),
    modalTitle: document.getElementById("carsModalTitle"),
    modalMedia: document.getElementById("carsModalMedia"),
    modalPrice: document.getElementById("carsModalPrice"),
    modalSub: document.getElementById("carsModalSub"),
    modalList: document.getElementById("carsModalList"),
    modalLink: document.getElementById("carsModalLink"),
  };

  /* =========================================================
     DOMAIN: CLEAN / PARSE / DEDUPE
  ========================================================= */
  function cleanValue(v){
    if (v===undefined||v===null) return null;
    const s=String(v).trim(); if(!s) return null;
    const l=s.toLowerCase();
    if(["nan","null","undefined"].includes(l)) return null;
    return s;
  }
  function normalizeLower(v){ const c=cleanValue(v); return c?c.toLowerCase():null; }

  function parseNumber(value){
    const digits = cleanValue(value)?.replace(/[^0-9-]/g,"");
    if(!digits) return null;
    const n=Number(digits);
    return Number.isFinite(n)?n:null;
  }

  function parseYear(value){
    const n = parseNumber(value);
    if(!n) return null;
    if(n < 1950 || n > 2050) return null;
    return n;
  }

  function parseDate(value){
    const v=cleanValue(value); if(!v) return null;
    const d=new Date(v); return Number.isFinite(d.getTime())?d:null;
  }

  function detectDelimiter(text){
    const first=text.split(/\r?\n/)[0]||"";
    const sc=(first.match(/;/g)||[]).length;
    const cc=(first.match(/,/g)||[]).length;
    if(sc>cc) return ";";
    if(cc>sc) return ",";
    return ";";
  }

  function parseCSV(text){
    const delimiter=detectDelimiter(text);
    const lines=text.split(/\r?\n/).filter(l=>l.trim()!=="");
    if(!lines.length) return [];
    const header=lines.shift().split(delimiter).map(h=>h.trim());
    return lines.map(line=>{
      const cells=line.split(delimiter);
      const row={};
      header.forEach((k,i)=> row[k]=cells[i]??"");
      return row;
    });
  }

  function getFirstImage(urls){
    const val=cleanValue(urls); if(!val) return null;
    const parts=val.split(/\s*\|\s*|\s*,\s*/).filter(Boolean);
    return parts[0]||null;
  }

  function normalizeRegion(region){
    const r = normalizeLower(region);
    if(!r) return null;
    // AO Москвы пропускаем отдельно
    if(MOSCOW_AO.includes(r)) return r;

    // федеральные субъекты
    if(VALID_REGIONS.includes(r)) return r;

    // частичные совпадения (тип "краснодар" -> "краснодарский край")
    const found = VALID_REGIONS.find(v =>
      r === v ||
      r.includes(v) ||
      v.includes(r)
    );
    return found || null;
  }

  function isDealerBySellerName(name){
    const n = normalizeLower(name);
    if(!n) return false;
    return DEALER_HINTS.some(h => n.includes(h));
  }

  function buildCar(row, kind, fileIndex){
    const mark=cleanValue(row.mark);
    const model=cleanValue(row.model);
    const year=parseYear(row.year);
    const color=cleanValue(row.color);
    const region=cleanValue(row.region);
    const regionNorm=normalizeRegion(region);

    const city=cleanValue(row.city);
    const kmAge=parseNumber(row.km_age);
    const priceValue=parseNumber(row.price_rub);

    const priceText=priceValue
      ? new Intl.NumberFormat("ru-RU").format(priceValue)+" ₽"
      : cleanValue(row.price_rub);

    const updatedAt=parseDate(row.updated_at);
    const url=cleanValue(row.url);
    const image=getFirstImage(row.image_urls);
    const condition=kmAge>0 ? "used" : "new";

    const sellerName = cleanValue(row.seller || row.seller_name || row.owner || row.dealer);
    const sellerType = isDealerBySellerName(sellerName) ? "dealer" : "owner";
    const accountId = cleanValue(row.account_id || row.seller_id || row.user_id);

    const dedupeKey = url || [
      normalizeLower(mark)||"",
      normalizeLower(model)||"",
      year||"",
      priceValue||"",
      regionNorm||"",
      normalizeLower(city)||"",
      kmAge||""
    ].join("|");

    return {
      raw: row, kind, fileIndex, dedupeKey, updatedAt,
      id: cleanValue(row.id),
      inner_id: cleanValue(row.inner_id),
      account_id: accountId,

      mark, markNorm: normalizeLower(mark),
      model, modelNorm: normalizeLower(model),
      year,
      color, colorNorm: normalizeLower(color),

      region, regionNorm,
      city,

      kmAge, condition,
      priceValue, priceText,

      bodyType: cleanValue(row.body_type),
      generation: cleanValue(row.generation),
      complectation: cleanValue(row.complectation),
      engineType: cleanValue(row.engine_type),
      displacement: cleanValue(row.displacement),
      horsePower: cleanValue(row.horse_power),
      transmission: cleanValue(row.transmission),
      driveType: cleanValue(row.drive_type),

      sellerName,
      sellerType,

      image, url,
    };
  }

  function signatureFromText(texts){
    let acc=0;
    texts.forEach(t=>{
      for(let i=0;i<t.length;i++){
        acc=(acc*31+t.charCodeAt(i))>>>0;
      }
      acc=(acc^t.length)>>>0;
    });
    return String(acc);
  }

  function dedupeCars(cars){
    const map=new Map();
    cars.forEach(car=>{
      if(!car.url) return;
      const ex=map.get(car.dedupeKey);
      if(!ex){ map.set(car.dedupeKey,car); return; }
      if(car.updatedAt && ex.updatedAt){
        if(car.updatedAt>ex.updatedAt) map.set(car.dedupeKey,car);
        return;
      }
      if(car.updatedAt && !ex.updatedAt){ map.set(car.dedupeKey,car); return; }
      if(!car.updatedAt && !ex.updatedAt){
        if(car.fileIndex>=ex.fileIndex) map.set(car.dedupeKey,car);
      }
    });
    return [...map.values()];
  }

  /* =========================================================
     DATA LOADING + hourly sync
  ========================================================= */
  async function fetchCsvSafe(url){
    try{
      const r=await fetch(url,{cache:"no-store"});
      if(!r.ok) return null;
      return await r.text();
    }catch{ return null; }
  }

  async function loadCarsKind(kind){
    const urls=CSV_SOURCES[kind]||[];
    const texts=[];
    for(let i=0;i<urls.length;i++){
      const url=urls[i];
      const text=await fetchCsvSafe(url);
      if(text) texts.push({url,text,fileIndex:i});
    }

    const signature=signatureFromText(texts.map(x=>x.text));
    const cars=texts.flatMap(({text,fileIndex}) =>
      parseCSV(text).map(row=>buildCar(row,kind,fileIndex))
    );
    const deduped=dedupeCars(cars);

    return { cars: deduped, signature };
  }

  async function initialLoadAll(){
    const active=await loadCarsKind("active");
    const removed=await loadCarsKind("removed");

    state.allCarsActive=active.cars;
    state.allCarsRemoved=removed.cars;
    state.lastSignatures.active=active.signature;
    state.lastSignatures.removed=removed.signature;

    state.isBooted=true;
    updateAll(true);
  }

  async function syncIfChanged(kind){
    const res=await loadCarsKind(kind);
    if(res.signature===state.lastSignatures[kind]) return false;
    state.lastSignatures[kind]=res.signature;
    if(kind==="active") state.allCarsActive=res.cars;
    else state.allCarsRemoved=res.cars;
    return true;
  }

  function startHourlySync(){
    setInterval(async ()=>{
      const a=await syncIfChanged("active");
      const r=await syncIfChanged("removed");
      if((a||r) && state.lastRenderKind===state.status){
        updateAll(false);
      }
    }, UPDATE_INTERVAL_MS);
  }

  /* =========================================================
     FILTERING / OPTIONS / COUNTS
  ========================================================= */
  function uniqOptions(cars,key,displayKey=key){
    const map=new Map();
    cars.forEach(car=>{
      const norm=car[`${key}Norm`];
      if(!norm) return;
      if(!map.has(norm)){
        map.set(norm, car[displayKey]||car[key]||"");
      }
    });
    return [...map.entries()].map(([value,label])=>({value,label}));
  }

  function uniqYears(cars){
    const set=new Set();
    cars.forEach(c=>{ if(c.year) set.add(c.year); });
    return [...set].sort((a,b)=>b-a).map(y=>({value:String(y),label:String(y)}));
  }

  function applyFilters(cars,current){
    return cars.filter(car=>{
      if(!car.url) return false;

      if(current.condition!=="all" && car.condition!==current.condition) return false;
      if(current.sellerType!=="all" && car.sellerType!==current.sellerType) return false;

      if(current.filters.mark && car.markNorm!==current.filters.mark) return false;
      if(current.filters.model && car.modelNorm!==current.filters.model) return false;
      if(current.filters.year && String(car.year)!==current.filters.year) return false;
      if(current.filters.color && car.colorNorm!==current.filters.color) return false;
      if(current.filters.region && car.regionNorm!==current.filters.region) return false;

      return true;
    });
  }

  function filteredExcept(baseCars,key){
    const copy={
      condition: state.condition,
      status: state.status,
      sellerType: state.sellerType,
      filters: {...state.filters},
    };
    copy.filters[key]=null;
    return applyFilters(baseCars,copy);
  }

  function renderOptions(select, options, placeholder){
    select.innerHTML="";
    const empty=document.createElement("option");
    empty.value="";
    empty.textContent=placeholder;
    select.appendChild(empty);

    options.forEach(opt=>{
      const o=document.createElement("option");
      o.value=opt.value;
      o.textContent=opt.label;
      select.appendChild(o);
    });

    const current=state.filters[select.dataset.key];
    select.value=current||"";
  }

  function renderRegions(select, options){
    select.innerHTML="";

    const empty=document.createElement("option");
    empty.value="";
    empty.textContent="Не выбран";
    select.appendChild(empty);

    const ao = options.filter(o=>MOSCOW_AO.includes(o.value));
    const rf = options.filter(o=>!MOSCOW_AO.includes(o.value));

    if(ao.length){
      const og=document.createElement("optgroup");
      og.label="Москва — округа";
      ao.forEach(opt=>{
        const o=document.createElement("option");
        o.value=opt.value; o.textContent=opt.label.toUpperCase();
        og.appendChild(o);
      });
      select.appendChild(og);
    }

    if(rf.length){
      const og=document.createElement("optgroup");
      og.label="Регионы РФ";
      rf.sort((a,b)=>a.label.localeCompare(b.label)).forEach(opt=>{
        const o=document.createElement("option");
        o.value=opt.value; o.textContent=opt.label;
        og.appendChild(o);
      });
      select.appendChild(og);
    }

    select.value=state.filters.region||"";
  }

  function updateOptions(baseCars){
    const marks=uniqOptions(filteredExcept(baseCars,"mark"),"mark");
    const models=uniqOptions(filteredExcept(baseCars,"model"),"model");
    const years=uniqYears(filteredExcept(baseCars,"year"));
    const colors=uniqOptions(filteredExcept(baseCars,"color"),"color");
    const regions=uniqOptions(filteredExcept(baseCars,"region"),"region","region");

    const selects=new Map([
      ["mark",marks],["model",models],["year",years],["color",colors],["region",regions],
    ]);

    let invalid=false;
    for(const [key,opts] of selects.entries()){
      const current=state.filters[key];
      if(current && !opts.some(o=>o.value===current)){
        state.filters[key]=null; invalid=true;
      }
    }
    if(invalid) return true;

    elements.selectMark.dataset.key="mark";
    elements.selectModel.dataset.key="model";
    elements.selectYear.dataset.key="year";
    elements.selectColor.dataset.key="color";
    elements.selectRegion.dataset.key="region";

    renderOptions(elements.selectMark, marks.sort((a,b)=>a.label.localeCompare(b.label)),"Не выбрана");
    renderOptions(elements.selectModel, models.sort((a,b)=>a.label.localeCompare(b.label)),"Не выбрана");
    renderOptions(elements.selectYear, years,"Не выбран");
    renderOptions(elements.selectColor, colors.sort((a,b)=>a.label.localeCompare(b.label)),"Не выбран");
    renderRegions(elements.selectRegion, regions);

    return false;
  }

  function updateCounts(filtered){
    const n=filtered.length;
    elements.showBtn.textContent=`Найдено ${n} объявлений`;
    elements.showBtn.disabled = n===0;
  }

  function syncFieldContainers(){
    elements.fields.forEach(field=>{
      const select=field.querySelector("select");
      field.classList.toggle("has-value", Boolean(select?.value));
    });
  }

  function setActionsLoading(on){
    elements.actions.classList.toggle("is-loading", on);
  }

  /* =========================================================
     RENDER CARDS
  ========================================================= */
  function buildCardMain(car){
    const bits=[];
    if(car.mark) bits.push(car.mark);
    if(car.model) bits.push(car.model);
    if(car.year) bits.push(car.year);
    if(car.color) bits.push(car.color);
    return bits.join(" ");
  }

  function buildCardSub(car){
    const bits=[];
    if(car.kmAge!==null && car.kmAge!==undefined){
      bits.push(`${new Intl.NumberFormat("ru-RU").format(car.kmAge)} км`);
    }
    const body=[car.complectation,car.generation].filter(Boolean).join(" / ");
    if(body) bits.push(body);
    const location=[car.region,car.city].filter(Boolean).join(", ");
    if(location) bits.push(location);
    return bits.join(" · ");
  }

  function renderCards(filtered){
    elements.grid.innerHTML="";
    if(!filtered.length){
      elements.grid.innerHTML='<div class="ty-body cars-empty">Нет объявлений</div>';
      return;
    }
    filtered.forEach(car=>{
      const card=document.createElement("article");
      card.className="cars-card";
      card.dataset.key=car.dedupeKey;

      const title=document.createElement("div");
      title.className="cars-card-title";
      title.textContent=buildCardMain(car);

      const sub=document.createElement("div");
      sub.className="cars-card-sub";
      sub.textContent=buildCardSub(car);

      card.appendChild(title);
      card.appendChild(sub);
      card.addEventListener("click",()=>openModal(car));
      elements.grid.appendChild(card);
    });
  }

  /* =========================================================
     MODAL
  ========================================================= */
  function buildModalSub(car){
    const bits=[];
    if(car.year) bits.push(car.year);
    if(car.kmAge!==null && car.kmAge!==undefined){
      bits.push(`${new Intl.NumberFormat("ru-RU").format(car.kmAge)} км`);
    }
    const body=[car.bodyType,car.generation,car.complectation].filter(Boolean).join(" / ");
    if(body) bits.push(body);
    const loc=[car.region,car.city].filter(Boolean).join(", ");
    if(loc) bits.push(loc);
    return bits.join(" · ");
  }

  function buildDetailsList(car){
    const items=[];
    Object.entries(car.raw).forEach(([k,v])=>{
      if(EXCLUDED_DETAILS.has(k)) return;
      const c=cleanValue(v);
      if(!c) return;
      const label = FIELD_RU[k] || k;
      items.push([label,c]);
    });

    if(car.sellerName) items.push(["Продавец", car.sellerName]);
    if(car.account_id) items.push(["Айди аккаунта", car.account_id]);

    return items;
  }

  function openModal(car){
    elements.modalTitle.textContent=buildCardMain(car);
    elements.modalPrice.textContent=car.priceText||"";
    elements.modalSub.textContent=buildModalSub(car);

    elements.modalMedia.innerHTML="";
    if(car.image){
      const img=document.createElement("img");
      img.src=car.image;
      img.alt=elements.modalTitle.textContent;
      elements.modalMedia.appendChild(img);
    }

    elements.modalList.innerHTML="";
    buildDetailsList(car).forEach(([k,v])=>{
      const li=document.createElement("li");
      li.textContent=`${k}: ${v}`;
      elements.modalList.appendChild(li);
    });

    if(car.url){
      elements.modalLink.href=car.url;
      elements.modalLink.style.display="";
    } else {
      elements.modalLink.removeAttribute("href");
      elements.modalLink.style.display="none";
    }

    elements.modal.classList.add("is-open");
    elements.modal.setAttribute("aria-hidden","false");
    document.body.style.overflow="hidden";
  }

  function closeModal(){
    elements.modal.classList.remove("is-open");
    elements.modal.setAttribute("aria-hidden","true");
    document.body.style.overflow="";
  }

  elements.modal.addEventListener("click",(e)=>{
    if(e.target.closest("[data-modal-close]")) closeModal();
  });
  window.addEventListener("keydown",(e)=>{
    if(e.key==="Escape" && elements.modal.classList.contains("is-open")) closeModal();
  });

  /* =========================================================
     UPDATE FLOW
  ========================================================= */
  function updateAll(render=true){
    const baseCars = state.status==="active" ? state.allCarsActive : state.allCarsRemoved;
    const filtered = applyFilters(baseCars, state);
    state.filtered = filtered;
    state.lastRenderKind = state.status;

    const needsRecalc = updateOptions(baseCars);
    if(needsRecalc){ updateAll(render); return; }

    updateCounts(filtered);
    syncFieldContainers();

    if(render) renderCards(filtered);
  }

  /* =========================================================
     BINDINGS
  ========================================================= */
  function bindTabs(){
    // condition
    elements.tabsCondition.forEach(btn=>{
      btn.addEventListener("click",()=>{
        if(btn.getAttribute("aria-pressed")==="true") return;
        elements.tabsCondition.forEach(b=>b.setAttribute("aria-pressed","false"));
        btn.setAttribute("aria-pressed","true");
        state.condition=btn.dataset.condition;

        updateAll(true);
      });
    });

    // status
    elements.tabsStatus.forEach(btn=>{
      btn.addEventListener("click",()=>{
        if(btn.getAttribute("aria-pressed")==="true") return;
        elements.tabsStatus.forEach(b=>b.setAttribute("aria-pressed","false"));
        btn.setAttribute("aria-pressed","true");
        state.status=btn.dataset.status;

        // 2 секунды "выплывание"
        setActionsLoading(true);
        elements.showBtn.disabled=true;

        updateAll(true);

        setTimeout(()=>{
          setActionsLoading(false);
          updateCounts(state.filtered);
        }, 2000);
      });
    });

    // seller
    elements.tabsSeller.forEach(btn=>{
      btn.addEventListener("click",()=>{
        if(btn.getAttribute("aria-pressed")==="true") return;
        elements.tabsSeller.forEach(b=>b.setAttribute("aria-pressed","false"));
        btn.setAttribute("aria-pressed","true");
        state.sellerType=btn.dataset.seller;

        updateAll(true);
      });
    });
  }

  function bindSelects(){
    [elements.selectMark,elements.selectModel,elements.selectYear,elements.selectColor,elements.selectRegion]
      .forEach(select=>{
        select.addEventListener("change",()=>{
          const key=select.dataset.key;
          state.filters[key]=select.value || null;
          updateAll(true);
        });
      });
  }

  function bindActions(){
    elements.resetBtn.addEventListener("click",()=>{
      state.condition="all";
      state.status="active";
      state.sellerType="all";
      state.filters={mark:null,model:null,year:null,color:null,region:null};

      elements.tabsCondition.forEach(btn=>
        btn.setAttribute("aria-pressed", btn.dataset.condition==="all" ? "true":"false")
      );
      elements.tabsStatus.forEach(btn=>
        btn.setAttribute("aria-pressed", btn.dataset.status==="active" ? "true":"false")
      );
      elements.tabsSeller.forEach(btn=>
        btn.setAttribute("aria-pressed", btn.dataset.seller==="all" ? "true":"false")
      );

      setActionsLoading(true);
      updateAll(true);
      setTimeout(()=>setActionsLoading(false), 200);
    });

    // show кнопка теперь просто перерендерит (на всякий)
    elements.showBtn.addEventListener("click",()=>{
      if(!state.filtered.length) return;
      renderCards(state.filtered);
    });
  }

  /* =========================================================
     BOOT ONCE
  ========================================================= */
  if(!state.isBooted){
    initialLoadAll();
    bindTabs();
    bindSelects();
    bindActions();
    startHourlySync();

    // стартовое выплывание
    setTimeout(()=>setActionsLoading(false), 2000);
  }
  </script>
</section>
