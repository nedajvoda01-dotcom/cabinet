<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Поиск автомобилей</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>

<!-- ======================================================================
     BLOCK 1) CARS PAGE MARKUP (NO LOCAL STYLES)
====================================================================== -->
<section class="cars-page" aria-label="Поиск автомобилей" data-cars-root>
  <div class="cars-shell">

    <div class="cars-filters" role="region" aria-label="Фильтры поиска">
      <div class="cars-tabs cars-tabs--condition" role="tablist" aria-label="Тип авто">
        <button class="cars-tab cars-tab--condition" data-condition="all" aria-pressed="true" type="button">Все</button>
        <button class="cars-tab cars-tab--condition" data-condition="used" aria-pressed="false" type="button">С пробегом</button>
        <button class="cars-tab cars-tab--condition" data-condition="new" aria-pressed="false" type="button">Новые</button>
      </div>

      <div class="cars-tabs cars-tabs--status tier-2" role="tablist" aria-label="Статус объявления">
        <button class="cars-tab cars-tab--status" data-status="active" aria-pressed="true" type="button">Активные объявления</button>
        <button class="cars-tab cars-tab--status" data-status="removed" aria-pressed="false" type="button">Снятые объявления</button>
      </div>

      <div class="cars-controls">
        <div class="cars-selects">
          <div class="cars-field cars-field--mark" data-label="Марка" data-field="mark">
            <select class="cars-input ty-body" id="filterMark" aria-label="Марка"></select>
          </div>

          <div class="cars-field cars-field--model" data-label="Модель" data-field="model">
            <select class="cars-input ty-body" id="filterModel" aria-label="Модель"></select>
          </div>

          <div class="cars-field cars-field--year" data-label="Год" data-field="year">
            <select class="cars-input ty-body" id="filterYear" aria-label="Год"></select>
          </div>

          <div class="cars-field cars-field--color" data-label="Цвет" data-field="color">
            <select class="cars-input ty-body" id="filterColor" aria-label="Цвет"></select>
          </div>

          <div class="cars-field cars-field--region" data-label="Регион" data-field="region">
            <select class="cars-input ty-body" id="filterRegion" aria-label="Регион"></select>
          </div>
        </div>

        <div class="cars-actions">
          <div class="cars-actions-btns">
            <button class="cars-btn cars-btn--reset ghost ty-section" type="button" id="carsReset">Сбросить</button>
            <button class="cars-btn cars-btn--show ty-section" type="button" id="carsShow" disabled>Показать 0 объявлений</button>
          </div>
          <div class="cars-status ty-section" id="carsStatus" aria-live="polite">Загружаем данные…</div>
        </div>
      </div>
    </div>

    <div class="cars-results" role="region" aria-label="Результаты поиска">
      <div class="cars-results-head">
        <div class="ty-section" id="sectorTitle">Активные объявления</div>
        <div class="ty-body cars-results-note">Выдача обновляется по кнопке “Показать”.</div>
      </div>
      <div class="cars-grid" id="carsGrid" aria-live="polite">
        <div class="ty-body cars-empty">Выбор фильтров не применён. Нажмите «Показать».</div>
      </div>
    </div>

  </div>

  <div class="cars-modal" id="carsModal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Детали объявления">
    <div class="cars-modal-backdrop" data-modal-close></div>
    <div class="cars-modal-card" role="document">
      <div class="cars-modal-head">
        <div class="cars-modal-title ty-title" id="carsModalTitle"></div>
        <button class="cars-modal-close ty-section" type="button" data-modal-close aria-label="Закрыть">Закрыть</button>
      </div>
      <div class="cars-modal-body">
        <div class="cars-modal-media" id="carsModalMedia"></div>
        <div class="cars-modal-info">
          <div class="cars-modal-price ty-title" id="carsModalPrice"></div>
          <div class="cars-modal-sub ty-body" id="carsModalSub"></div>
          <ul class="cars-modal-list ty-body" id="carsModalList"></ul>
          <a class="cars-btn ty-section cars-modal-link" id="carsModalLink" target="_blank" rel="noopener">Перейти к объявлению</a>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
/* ======================================================================
   BLOCK 2) CARS CONSTS / CONFIG
====================================================================== */
const CSV_SOURCES = {
  active: [
    "data/active/autoru_car_active.csv",
    "data/active/autoru_car_active2.csv",
    "data/active/autoru_car_active3.csv",
  ],
  removed: [
    "data/removed/autoru_car_removed.csv",
    "data/removed/autoru_car_removed2.csv",
    "data/removed/autoru_car_removed3.csv",
  ],
};

const UPDATE_INTERVAL_MS = 60 * 60 * 1000;

const EXCLUDED_DETAILS = new Set([
  "image_urls",
]);

/* ======================================================================
   BLOCK 3) CARS STATE + ELEMENTS
====================================================================== */
const state = {
  allCarsActive: [],
  allCarsRemoved: [],
  filtered: [],
  condition: "all",
  status: "active",
  filters: {
    mark: null,
    model: null,
    year: null,
    color: null,
    region: null,
  },
  lastSignatures: {
    active: null,
    removed: null,
  },
  lastRenderKind: "active",
};

const elements = {
  root: document.querySelector("[data-cars-root]"),
  status: document.getElementById("carsStatus"),
  tabsCondition: [...document.querySelectorAll("[data-condition]")],
  tabsStatus: [...document.querySelectorAll("[data-status]")],
  selectMark: document.getElementById("filterMark"),
  selectModel: document.getElementById("filterModel"),
  selectYear: document.getElementById("filterYear"),
  selectColor: document.getElementById("filterColor"),
  selectRegion: document.getElementById("filterRegion"),
  resetBtn: document.getElementById("carsReset"),
  showBtn: document.getElementById("carsShow"),
  grid: document.getElementById("carsGrid"),
  sectorTitle: document.getElementById("sectorTitle"),
  fields: [...document.querySelectorAll(".cars-field")],
  modal: document.getElementById("carsModal"),
  modalTitle: document.getElementById("carsModalTitle"),
  modalMedia: document.getElementById("carsModalMedia"),
  modalPrice: document.getElementById("carsModalPrice"),
  modalSub: document.getElementById("carsModalSub"),
  modalList: document.getElementById("carsModalList"),
  modalLink: document.getElementById("carsModalLink"),
};

/* ======================================================================
   BLOCK 4) CARS DOMAIN: CLEAN / NORMALIZE / PARSE
====================================================================== */
function cleanValue(v) {
  if (v === undefined || v === null) return null;
  const str = String(v).trim();
  if (!str) return null;
  const lower = str.toLowerCase();
  if (["nan", "null", "undefined"].includes(lower)) return null;
  return str;
}

function normalizeLower(v) {
  const val = cleanValue(v);
  return val ? val.toLowerCase() : null;
}

function parseNumber(value) {
  const digits = cleanValue(value)?.replace(/[^0-9-]/g, "");
  if (!digits) return null;
  const num = Number(digits);
  return Number.isFinite(num) ? num : null;
}

function parseDate(value) {
  const v = cleanValue(value);
  if (!v) return null;
  const d = new Date(v);
  return Number.isFinite(d.getTime()) ? d : null;
}

function detectDelimiter(text) {
  const firstLine = text.split(/\r?\n/)[0] || "";
  const countSemicolon = (firstLine.match(/;/g) || []).length;
  const countComma = (firstLine.match(/,/g) || []).length;
  if (countSemicolon > countComma) return ";";
  if (countComma > countSemicolon) return ",";
  return ";";
}

function parseCSV(text) {
  const delimiter = detectDelimiter(text);
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
  if (lines.length === 0) return [];
  const header = lines.shift().split(delimiter).map(h => h.trim());

  return lines.map(line => {
    const cells = line.split(delimiter);
    const row = {};
    header.forEach((key, idx) => {
      row[key] = cells[idx] !== undefined ? cells[idx] : "";
    });
    return row;
  });
}

function getFirstImage(urls) {
  const val = cleanValue(urls);
  if (!val) return null;
  const parts = val.split(/\s*\|\s*|\s*,\s*/).filter(Boolean);
  return parts[0] || null;
}

function buildCar(row, kind, fileIndex) {
  const mark = cleanValue(row.mark);
  const model = cleanValue(row.model);
  const year = parseNumber(row.year);
  const color = cleanValue(row.color);
  const region = cleanValue(row.region);
  const city = cleanValue(row.city);
  const kmAge = parseNumber(row.km_age);
  const priceValue = parseNumber(row.price_rub);
  const priceText = priceValue
    ? new Intl.NumberFormat("ru-RU").format(priceValue) + " ₽"
    : cleanValue(row.price_rub);

  const updatedAt = parseDate(row.updated_at);

  const url = cleanValue(row.url);
  const image = getFirstImage(row.image_urls);

  const condition = kmAge > 0 ? "used" : "new";

  const dedupeKey =
    url ||
    [
      normalizeLower(mark) || "",
      normalizeLower(model) || "",
      year || "",
      priceValue || "",
      normalizeLower(region) || "",
      normalizeLower(city) || "",
      kmAge || ""
    ].join("|");

  return {
    raw: row,
    kind,
    fileIndex,
    dedupeKey,
    updatedAt,
    mark,
    markNorm: normalizeLower(mark),
    model,
    modelNorm: normalizeLower(model),
    year,
    color,
    colorNorm: normalizeLower(color),
    region,
    regionNorm: normalizeLower(region),
    city,
    kmAge,
    condition,
    priceValue,
    priceText,
    bodyType: cleanValue(row.body_type),
    generation: cleanValue(row.generation),
    complectation: cleanValue(row.complectation),
    engineType: cleanValue(row.engine_type),
    displacement: cleanValue(row.displacement),
    horsePower: cleanValue(row.horse_power),
    transmission: cleanValue(row.transmission),
    driveType: cleanValue(row.drive_type),
    image,
    url,
  };
}

function uniqOptions(cars, key, displayKey = key) {
  const map = new Map();
  cars.forEach(car => {
    const norm = car[`${key}Norm`];
    if (!norm) return;
    if (!map.has(norm)) {
      const labelSource = car[displayKey] || car[key];
      map.set(norm, labelSource || "");
    }
  });
  return [...map.entries()].map(([value, label]) => ({ value, label }));
}

function uniqYears(cars) {
  const set = new Set();
  cars.forEach(car => { if (car.year) set.add(car.year); });
  return [...set].sort((a, b) => b - a).map(y => ({ value: String(y), label: String(y) }));
}

function applyFilters(cars, current) {
  return cars.filter(car => {
    if (!car.url) return false;
    if (current.condition !== "all" && car.condition !== current.condition) return false;
    if (current.filters.mark && car.markNorm !== current.filters.mark) return false;
    if (current.filters.model && car.modelNorm !== current.filters.model) return false;
    if (current.filters.year && String(car.year) !== current.filters.year) return false;
    if (current.filters.color && car.colorNorm !== current.filters.color) return false;
    if (current.filters.region && car.regionNorm !== current.filters.region) return false;
    return true;
  });
}

function filteredExcept(baseCars, key) {
  const copy = {
    condition: state.condition,
    status: state.status,
    filters: { ...state.filters },
  };
  copy.filters[key] = null;
  return applyFilters(baseCars, copy);
}

function signatureFromText(texts) {
  let acc = 0;
  texts.forEach(t => {
    for (let i = 0; i < t.length; i++) {
      acc = (acc * 31 + t.charCodeAt(i)) >>> 0;
    }
    acc = (acc ^ t.length) >>> 0;
  });
  return String(acc);
}

function dedupeCars(cars) {
  const map = new Map();
  cars.forEach(car => {
    const existing = map.get(car.dedupeKey);
    if (!existing) {
      map.set(car.dedupeKey, car);
      return;
    }
    if (car.updatedAt && existing.updatedAt) {
      if (car.updatedAt > existing.updatedAt) map.set(car.dedupeKey, car);
      return;
    }
    if (car.updatedAt && !existing.updatedAt) {
      map.set(car.dedupeKey, car);
      return;
    }
    if (!car.updatedAt && !existing.updatedAt) {
      if (car.fileIndex >= existing.fileIndex) map.set(car.dedupeKey, car);
    }
  });
  return [...map.values()];
}

/* ======================================================================
   BLOCK 5) CARS DATA LOADING + SYNC
====================================================================== */
async function fetchCsvSafe(url) {
  try {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) return null;
    const text = await r.text();
    return text;
  } catch {
    return null;
  }
}

async function loadCarsKind(kind) {
  const urls = CSV_SOURCES[kind] || [];
  const texts = [];
  for (let i = 0; i < urls.length; i++) {
    const url = urls[i];
    const text = await fetchCsvSafe(url);
    if (text) texts.push({ url, text, fileIndex: i });
  }

  const signature = signatureFromText(texts.map(x => x.text));
  const rows = texts.flatMap(({ text }) => parseCSV(text));
  const cars = texts.flatMap(({ text, fileIndex }) =>
    parseCSV(text).map(row => buildCar(row, kind, fileIndex))
  );

  const deduped = dedupeCars(cars);
  return { cars: deduped, signature, rawCount: rows.length };
}

async function initialLoadAll() {
  elements.status.textContent = "Загружаем CSV…";

  const active = await loadCarsKind("active");
  const removed = await loadCarsKind("removed");

  console.log("CSV kind: active", "urls:", CSV_SOURCES.active);
  console.log("parsed rows active:", active.rawCount);
  console.log("deduped active:", active.cars.length);

  console.log("CSV kind: removed", "urls:", CSV_SOURCES.removed);
  console.log("parsed rows removed:", removed.rawCount);
  console.log("deduped removed:", removed.cars.length);

  state.allCarsActive = active.cars;
  state.allCarsRemoved = removed.cars;
  state.lastSignatures.active = active.signature;
  state.lastSignatures.removed = removed.signature;

  elements.status.textContent = "Данные загружены";
  updateAll();
}

async function syncIfChanged(kind) {
  const res = await loadCarsKind(kind);
  if (res.signature === state.lastSignatures[kind]) return false;
  state.lastSignatures[kind] = res.signature;
  if (kind === "active") state.allCarsActive = res.cars;
  else state.allCarsRemoved = res.cars;
  return true;
}

function startHourlySync() {
  setInterval(async () => {
    const changedActive = await syncIfChanged("active");
    const changedRemoved = await syncIfChanged("removed");
    if (changedActive || changedRemoved) {
      if (state.lastRenderKind === state.status) updateAll(false);
    }
  }, UPDATE_INTERVAL_MS);
}

/* ======================================================================
   BLOCK 6) UI HELPERS
====================================================================== */
function renderOptions(select, options, placeholder) {
  select.innerHTML = "";
  const empty = document.createElement("option");
  empty.value = "";
  empty.textContent = placeholder;
  select.appendChild(empty);
  options.forEach(opt => {
    const option = document.createElement("option");
    option.value = opt.value;
    option.textContent = opt.label;
    select.appendChild(option);
  });
  const current = state.filters[select.dataset.key];
  select.value = current || "";
}

function updateOptions(baseCars) {
  const marks = uniqOptions(filteredExcept(baseCars, "mark"), "mark");
  const models = uniqOptions(filteredExcept(baseCars, "model"), "model");
  const years = uniqYears(filteredExcept(baseCars, "year"));
  const colors = uniqOptions(filteredExcept(baseCars, "color"), "color");
  const regions = uniqOptions(filteredExcept(baseCars, "region"), "region");

  const selects = new Map([
    ["mark", marks],
    ["model", models],
    ["year", years],
    ["color", colors],
    ["region", regions],
  ]);

  let invalid = false;
  for (const [key, opts] of selects.entries()) {
    const current = state.filters[key];
    if (current && !opts.some(o => o.value === current)) {
      state.filters[key] = null;
      invalid = true;
    }
  }
  if (invalid) return true;

  elements.selectMark.dataset.key = "mark";
  elements.selectModel.dataset.key = "model";
  elements.selectYear.dataset.key = "year";
  elements.selectColor.dataset.key = "color";
  elements.selectRegion.dataset.key = "region";

  renderOptions(elements.selectMark, marks.sort((a,b)=>a.label.localeCompare(b.label)), "Не выбрана");
  renderOptions(elements.selectModel, models.sort((a,b)=>a.label.localeCompare(b.label)), "Не выбрана");
  renderOptions(elements.selectYear, years, "Не выбран");
  renderOptions(elements.selectColor, colors.sort((a,b)=>a.label.localeCompare(b.label)), "Не выбран");
  renderOptions(elements.selectRegion, regions.sort((a,b)=>a.label.localeCompare(b.label)), "Не выбран");

  return false;
}

function updateCounts(filtered, baseTitle) {
  const n = filtered.length;
  elements.showBtn.textContent = `Показать ${n} объявлений`;
  elements.showBtn.disabled = n === 0;
  elements.sectorTitle.textContent = `${baseTitle} · ${n}`;
  if (elements.root) {
    elements.root.setAttribute("data-status", state.status);
    elements.root.setAttribute("data-condition", state.condition);
    elements.root.setAttribute("data-count", String(n));
  }
}

function syncFieldCapsules() {
  elements.fields.forEach(field => {
    const select = field.querySelector("select");
    if (!select) return;
    field.classList.toggle("has-value", Boolean(select.value));
  });
}

function buildCardMain(car) {
  const bits = [];
  if (car.mark) bits.push(car.mark);
  if (car.model) bits.push(car.model);
  if (car.year) bits.push(car.year);
  if (car.color) bits.push(car.color);
  return bits.join(" ");
}

function buildCardSub(car) {
  const bits = [];
  if (car.kmAge !== null && car.kmAge !== undefined) {
    bits.push(`${new Intl.NumberFormat("ru-RU").format(car.kmAge)} км`);
  }
  const body = [car.complectation, car.generation].filter(Boolean).join(" / ");
  if (body) bits.push(body);
  const location = [car.region, car.city].filter(Boolean).join(", ");
  if (location) bits.push(location);
  return bits.join(" · ");
}

function renderCards(filtered) {
  elements.grid.innerHTML = "";
  if (filtered.length === 0) {
    elements.grid.innerHTML = '<div class="ty-body cars-empty">Нет объявлений<\/div>';
    return;
  }

  filtered.forEach(car => {
    const card = document.createElement("article");
    card.className = "cars-card";
    card.dataset.key = car.dedupeKey;
    if (car.url) card.dataset.url = car.url;

    const title = document.createElement("div");
    title.className = "cars-card-title";
    title.textContent = buildCardMain(car);

    const sub = document.createElement("div");
    sub.className = "cars-card-sub";
    sub.textContent = buildCardSub(car);

    card.appendChild(title);
    card.appendChild(sub);

    card.addEventListener("click", () => openModal(car));

    elements.grid.appendChild(card);
  });
}

function renderEmptyHint() {
  elements.grid.innerHTML = '<div class="ty-body cars-empty">Выбор фильтров не применён. Нажмите «Показать».<\/div>';
}

/* ======================================================================
   BLOCK 7) MODAL
====================================================================== */
function buildModalSub(car) {
  const bits = [];
  if (car.year) bits.push(car.year);
  if (car.kmAge !== null && car.kmAge !== undefined) bits.push(`${new Intl.NumberFormat("ru-RU").format(car.kmAge)} км`);
  const body = [car.bodyType, car.generation, car.complectation].filter(Boolean).join(" / ");
  if (body) bits.push(body);
  const location = [car.region, car.city].filter(Boolean).join(", ");
  if (location) bits.push(location);
  return bits.join(" · ");
}

function buildDetailsList(car) {
  const items = [];
  Object.entries(car.raw).forEach(([key, value]) => {
    if (EXCLUDED_DETAILS.has(key)) return;
    const cleaned = cleanValue(value);
    if (!cleaned) return;
    items.push([key, cleaned]);
  });
  return items;
}

function openModal(car) {
  elements.modalTitle.textContent = buildCardMain(car);
  elements.modalPrice.textContent = car.priceText || "";
  elements.modalSub.textContent = buildModalSub(car);

  elements.modalMedia.innerHTML = "";
  if (car.image) {
    const img = document.createElement("img");
    img.src = car.image;
    img.alt = elements.modalTitle.textContent;
    elements.modalMedia.appendChild(img);
  }

  elements.modalList.innerHTML = "";
  const details = buildDetailsList(car);
  details.forEach(([k,v]) => {
    const li = document.createElement("li");
    li.textContent = `${k}: ${v}`;
    elements.modalList.appendChild(li);
  });

  if (car.url) {
    elements.modalLink.href = car.url;
    elements.modalLink.style.display = "";
  } else {
    elements.modalLink.removeAttribute("href");
    elements.modalLink.style.display = "none";
  }

  elements.modal.classList.add("is-open");
  elements.modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}

function closeModal() {
  elements.modal.classList.remove("is-open");
  elements.modal.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
}

elements.modal.addEventListener("click", (e) => {
  if (e.target.closest("[data-modal-close]")) closeModal();
});
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && elements.modal.classList.contains("is-open")) closeModal();
});

/* ======================================================================
   BLOCK 8) UPDATE FLOW
====================================================================== */
function updateAll(clearCards = true) {
  const baseCars = state.status === "active" ? state.allCarsActive : state.allCarsRemoved;
  const filtered = applyFilters(baseCars, state);
  state.filtered = filtered;
  state.lastRenderKind = state.status;

  const needsRecalc = updateOptions(baseCars);
  if (needsRecalc) {
    updateAll(clearCards);
    return;
  }

  const baseTitle = state.status === "active" ? "Активные объявления" : "Снятые объявления";
  updateCounts(filtered, baseTitle);
  syncFieldCapsules();

  if (clearCards) renderEmptyHint();
}

/* ======================================================================
   BLOCK 9) BINDINGS
====================================================================== */
function bindTabs() {
  elements.tabsCondition.forEach(btn => {
    btn.addEventListener("click", () => {
      if (btn.getAttribute("aria-pressed") === "true") return;
      elements.tabsCondition.forEach(b => b.setAttribute("aria-pressed", "false"));
      btn.setAttribute("aria-pressed", "true");
      state.condition = btn.dataset.condition;
      updateAll();
    });
  });

  elements.tabsStatus.forEach(btn => {
    btn.addEventListener("click", () => {
      if (btn.getAttribute("aria-pressed") === "true") return;
      elements.tabsStatus.forEach(b => b.setAttribute("aria-pressed", "false"));
      btn.setAttribute("aria-pressed", "true");
      state.status = btn.dataset.status;
      updateAll();
    });
  });
}

function bindSelects() {
  [
    elements.selectMark,
    elements.selectModel,
    elements.selectYear,
    elements.selectColor,
    elements.selectRegion,
  ].forEach(select => {
    select.addEventListener("change", () => {
      const key = select.dataset.key;
      const value = select.value || null;
      state.filters[key] = value ? value : null;
      updateAll();
      syncFieldCapsules();
    });
  });
}

function bindActions() {
  elements.resetBtn.addEventListener("click", () => {
    state.condition = "all";
    state.status = "active";
    state.filters = { mark: null, model: null, year: null, color: null, region: null };

    elements.tabsCondition.forEach(btn =>
      btn.setAttribute("aria-pressed", btn.dataset.condition === "all" ? "true" : "false")
    );
    elements.tabsStatus.forEach(btn =>
      btn.setAttribute("aria-pressed", btn.dataset.status === "active" ? "true" : "false")
    );

    updateAll();
  });

  elements.showBtn.addEventListener("click", () => {
    if (state.filtered.length === 0) return;
    renderCards(state.filtered);
  });
}

/* ======================================================================
   BLOCK 10) BOOT
====================================================================== */
initialLoadAll();
bindTabs();
bindSelects();
bindActions();
startHourlySync();
</script>

</body>
</html>
