<!-- pages/cars.html  ✅ ФРАГМЕНТ, НЕ ПОЛНЫЙ HTML-ДОКУМЕНТ -->

<section class="cars-page" aria-label="Поиск автомобилей" data-cars-root>
  <style>
    /* ======================================================================
       CARS PAGE — MOCKUP MATCH + VERY LIGHT "SMOKE" SHADOW
       ✔ одна капсула поиска
       ✔ табы в линию
       ✔ кнопки справа СНАРУЖИ
       ✔ карточки авто — отдельные капсулы
       ✔ нет общей капсулы/заголовков
       ✔ лоадер 2с при старте и смене active/removed
       ✔ только design tokens
    ====================================================================== */

    .cars-page{
      width:100%;
      display:flex;
      justify-content:center;
      padding: 22px 24px 28px;
      background: var(--c-white);
    }
    .cars-shell{
      width:100%;
      max-width: 980px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* ======== VERY LIGHT "SMOKE" (еле заметная дымка) ======== */
    .cars-smoke{
      box-shadow:
        0 1px 0 color-mix(in srgb, var(--c-black) 6%, transparent),
        0 8px 18px color-mix(in srgb, var(--c-black) 7%, transparent);
    }

    /* ------ Search capsule ------ */
    .cars-filters{
      background: var(--c-white);
      border: 1px solid var(--c-gray-light);
      border-radius: 18px;
      padding: 10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Tabs in one row */
    .cars-tabs-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .cars-tabs{
      display:flex;
      border:1px solid var(--c-gray-light);
      border-radius: 10px;
      background: var(--c-white);
      overflow:hidden;
      height: 30px;
    }

    .cars-tab{
      border:none;
      background: transparent;
      color: var(--c-gray);
      padding: 6px 12px 5px;
      cursor:pointer;
      transition: background 120ms ease, color 120ms ease;
      font: inherit;
      line-height: var(--lh-ui);
      letter-spacing: var(--ls-ui);
      font-size: var(--fs-12);
      font-weight: var(--fw-menu);
      white-space:nowrap;
    }
    .cars-tab + .cars-tab{
      border-left:1px solid var(--c-gray-light);
    }
    .cars-tab[aria-pressed="true"]{
      background: var(--c-gray-light);
      color: var(--c-black);
    }
    .cars-tab:hover{
      background: var(--c-gray-light);
      color: var(--c-black);
    }

    /* greenlight: status looks wider */
    .cars-tabs--status{ flex: 1 1 320px; }
    .cars-tabs--condition,
    .cars-tabs--seller{ flex: 0 0 auto; }

    /* Select grid */
    .cars-selects{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 980px){
      .cars-selects{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (max-width: 640px){
      .cars-selects{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 420px){
      .cars-selects{ grid-template-columns: 1fr; }
    }

    /* Field */
    .cars-field{
      position:relative;
      display:flex;
      align-items:center;
      background: var(--c-white);
      border:1px solid var(--c-gray-light);
      border-radius: 8px;
      padding: 6px 8px 4px;
      min-height: 40px;
      transition: border 120ms ease, background 120ms ease;
    }
    .cars-field:hover{
      border-color: var(--c-gray);
      background: color-mix(in srgb, var(--c-gray-light) 18%, var(--c-white));
    }
    .cars-field:focus-within{
      border-color: var(--c-gray-dark);
      background: var(--c-white);
    }

    /* soft placeholder label (не капсула) */
    .cars-field::before{
      content: attr(data-label);
      position:absolute;
      top:6px;
      left:10px;
      font-size: var(--fs-11);
      font-weight: var(--fw-menu);
      letter-spacing: var(--ls-ui);
      color: var(--c-gray-light);
      pointer-events:none;
      opacity:1;
      transition: color 140ms ease;
    }
    .cars-field.has-value::before{
      color: var(--c-gray);
    }

    .cars-input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      padding: 14px 4px 2px;
      font-size: var(--fs-13);
      font-weight: var(--fw-regular);
      line-height: var(--lh-ui);
      color: var(--c-black);
      appearance:none;
      cursor:pointer;
    }
    .cars-input:disabled{
      color: var(--c-gray-light);
      cursor:not-allowed;
    }

    /* Actions OUTSIDE capsule (как на мокапе) */
    .cars-actions-outside{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      margin-top:2px;
    }

    .cars-btn{
      border-radius: 10px;
      padding: 7px 10px 6px;
      border:1px solid var(--c-gray-light);
      background: var(--c-white);
      cursor:pointer;
      font-size: var(--fs-12);
      font-weight: var(--fw-menu);
      letter-spacing: var(--ls-ui);
      transition: background 120ms ease, border 120ms ease, color 120ms ease, opacity 120ms ease;
      color: var(--c-gray);
      height: 30px;
    }
    .cars-btn:hover{
      background: var(--c-gray-light);
      border-color: var(--c-gray);
      color: var(--c-black);
    }
    .cars-btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .cars-btn--show{
      background: var(--c-black);
      color: var(--c-white);
      border-color: var(--c-black);
    }
    .cars-btn--show:hover{
      background: var(--c-gray-dark);
      border-color: var(--c-gray-dark);
      color: var(--c-white);
    }

    /* loader ползунок */
    .cars-loader{
      position:relative;
      height: 4px;
      width: 120px;
      border-radius: 999px;
      background: var(--c-gray-light);
      overflow:hidden;
      opacity:0;
      transform: translateY(2px);
      transition: opacity 120ms ease;
    }
    .cars-loader.is-on{ opacity:1; }
    .cars-loader-bar{
      position:absolute; inset:0;
      width:40%;
      background: var(--c-black);
      border-radius:999px;
      transform: translateX(-120%);
      animation: carsLoaderMove 900ms ease-in-out infinite;
    }
    @keyframes carsLoaderMove{
      0%   { transform: translateX(-120%); }
      50%  { transform: translateX(180%); }
      100% { transform: translateX(180%); }
    }

    /* results list */
    .cars-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height: 80px;
      margin-top:6px;
    }

    .cars-card{
      border:1px solid var(--c-gray-light);
      border-radius:12px;
      background: var(--c-white);
      padding: 10px 12px;
      cursor:pointer;
      transition: background 120ms ease, border 120ms ease, transform 120ms ease;
    }
    .cars-card:hover{
      background: var(--c-gray-light);
      border-color: var(--c-gray);
      transform: translateY(-1px);
    }
    .cars-card-title{
      font-size: var(--fs-15);
      font-weight: var(--fw-semibold);
      line-height: var(--lh-snug);
      color: var(--c-black);
    }
    .cars-card-sub{
      margin-top:3px;
      font-size: var(--fs-13);
      font-weight: var(--fw-regular);
      line-height: var(--lh-normal);
      color: var(--c-gray);
    }
    .cars-empty{
      color: var(--c-gray);
      padding: 8px 2px;
    }

    /* modal */
    .cars-modal{ position:fixed; inset:0; display:none; z-index:999; }
    .cars-modal.is-open{ display:block; }
    .cars-modal-backdrop{
      position:absolute; inset:0;
      background: color-mix(in srgb, var(--c-black) 55%, transparent);
    }
    .cars-modal-card{
      position:relative;
      margin: 5vh auto 0;
      width: min(900px, 95vw);
      background: var(--c-white);
      border-radius: 16px;
      padding: 14px;
      border:1px solid var(--c-gray-light);
    }
    .cars-modal-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding: 4px 4px 8px;
      border-bottom:1px solid var(--c-gray-light);
    }
    .cars-modal-title{
      font-size: var(--fs-24);
      font-weight: var(--fw-semibold);
      line-height: var(--lh-snug);
      color: var(--c-black);
    }
    .cars-modal-close{
      border:none; background:transparent; cursor:pointer;
      font-size: var(--fs-12);
      font-weight: var(--fw-menu);
      color: var(--c-gray);
      padding:6px 8px;
      border-radius:8px;
      transition: background 120ms ease, color 120ms ease;
    }
    .cars-modal-close:hover{
      background: var(--c-gray-light);
      color: var(--c-black);
    }
    .cars-modal-body{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
      padding: 10px 4px 4px;
    }
    @media (max-width: 700px){
      .cars-modal-body{ grid-template-columns: 1fr; }
    }
    .cars-modal-media{
      border-radius: 12px;
      border:1px solid var(--c-gray-light);
      min-height: 220px;
      display:grid; place-items:center;
      overflow:hidden;
      background: var(--c-white);
    }
    .cars-modal-media img{ width:100%; height:100%; object-fit:cover; display:block; }
    .cars-modal-price{
      font-size: var(--fs-24);
      font-weight: var(--fw-semibold);
      margin-bottom:4px;
      color: var(--c-black);
    }
    .cars-modal-sub{
      color: var(--c-gray);
      margin-bottom:8px;
      font-size: var(--fs-13);
    }
    .cars-modal-list{
      list-style:none;
      padding-left:0;
      display:grid; gap:4px;
      font-size: var(--fs-13);
      color: var(--c-black);
    }
    .cars-modal-link{
      display:inline-flex;
      margin-top:10px;
      text-decoration:none;
      background: var(--c-black);
      color: var(--c-white);
      border-radius:10px;
      padding: 8px 12px 7px;
      font-size: var(--fs-12);
      font-weight: var(--fw-menu);
      letter-spacing: var(--ls-ui);
      width: fit-content;
      transition: background 120ms ease;
    }
    .cars-modal-link:hover{ background: var(--c-gray-dark); }
  </style>

  <div class="cars-shell">

    <!-- SEARCH CAPSULE -->
    <div class="cars-filters cars-smoke" role="region" aria-label="Фильтры поиска">

      <div class="cars-tabs-row">
        <!-- Status -->
        <div class="cars-tabs cars-tabs--status" role="tablist" aria-label="Статус объявления">
          <button class="cars-tab" data-status="removed" aria-pressed="false" type="button">Снятые объявления</button>
          <button class="cars-tab" data-status="active" aria-pressed="true"  type="button">Активные объявления</button>
        </div>

        <!-- Condition -->
        <div class="cars-tabs cars-tabs--condition" role="tablist" aria-label="Тип авто">
          <button class="cars-tab" data-condition="all"  aria-pressed="true"  type="button">Все</button>
          <button class="cars-tab" data-condition="used" aria-pressed="false" type="button">С пробегом</button>
          <button class="cars-tab" data-condition="new"  aria-pressed="false" type="button">Новые</button>
        </div>

        <!-- Seller -->
        <div class="cars-tabs cars-tabs--seller" role="tablist" aria-label="Продавец">
          <button class="cars-tab" data-seller="all"    aria-pressed="true"  type="button">Все</button>
          <button class="cars-tab" data-seller="owner"  aria-pressed="false" type="button">Собственник</button>
          <button class="cars-tab" data-seller="dealer" aria-pressed="false" type="button">Диллер</button>
        </div>
      </div>

      <div class="cars-selects">
        <div class="cars-field" data-label="Марка" data-field="mark">
          <select class="cars-input ty-body" id="filterMark" aria-label="Марка"></select>
        </div>

        <div class="cars-field" data-label="Модель" data-field="model">
          <select class="cars-input ty-body" id="filterModel" aria-label="Модель" disabled></select>
        </div>

        <div class="cars-field" data-label="Год" data-field="year">
          <select class="cars-input ty-body" id="filterYear" aria-label="Год"></select>
        </div>

        <div class="cars-field" data-label="Цвет" data-field="color">
          <select class="cars-input ty-body" id="filterColor" aria-label="Цвет"></select>
        </div>

        <div class="cars-field" data-label="Регион" data-field="region">
          <select class="cars-input ty-body" id="filterRegion" aria-label="Регион"></select>
        </div>
      </div>
    </div>

    <!-- ACTIONS (outside, right) -->
    <div class="cars-actions-outside">
      <button class="cars-btn cars-btn--reset ty-section" type="button" id="carsReset">Сбросить</button>
      <button class="cars-btn cars-btn--show ty-section" type="button" id="carsShow" disabled>Найдено 0 объявлений</button>
      <div class="cars-loader" id="carsLoader" aria-hidden="true"><div class="cars-loader-bar"></div></div>
    </div>

    <!-- RESULTS -->
    <div class="cars-grid" id="carsGrid" aria-live="polite"></div>

  </div>

  <!-- MODAL -->
  <div class="cars-modal" id="carsModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="cars-modal-backdrop" data-modal-close></div>
    <div class="cars-modal-card" role="document">
      <div class="cars-modal-head">
        <div class="cars-modal-title ty-title" id="carsModalTitle"></div>
        <button class="cars-modal-close ty-section" type="button" data-modal-close>Закрыть</button>
      </div>
      <div class="cars-modal-body">
        <div class="cars-modal-media" id="carsModalMedia"></div>
        <div class="cars-modal-info">
          <div class="cars-modal-price ty-title" id="carsModalPrice"></div>
          <div class="cars-modal-sub ty-body" id="carsModalSub"></div>
          <ul class="cars-modal-list ty-body" id="carsModalList"></ul>
          <a class="cars-modal-link ty-section" id="carsModalLink" target="_blank" rel="noopener">Перейти к объявлению</a>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ======================================================================
     CONFIG
  ====================================================================== */
  const CSV_SOURCES = {
    active: [
      "data/active/autoru_car_active.csv",
      "data/active/autoru_car_active2.csv",
      "data/active/autoru_car_active3.csv",
    ],
    removed: [
      "data/removed/autoru_car_removed.csv",
      "data/removed/autoru_car_removed2.csv",
      "data/removed/autoru_car_removed3.csv",
    ],
  };
  const UPDATE_INTERVAL_MS = 60 * 60 * 1000;
  const EXCLUDED_DETAILS = new Set(["image_urls"]);

  /* ======================================================================
     DOMAIN: RU labels + value translations
  ====================================================================== */
  const FIELD_LABELS_RU = {
    id: "ID объявления",
    inner_id: "Внутренний ID",
    seller_id: "ID аккаунта",
    mark: "Марка",
    model: "Модель",
    generation: "Поколение",
    configuration: "Кузов/конфиг",
    complectation: "Комплектация",
    url: "Ссылка",
    price_rub: "Цена ₽",
    price_usd: "Цена $",
    price_eur: "Цена €",
    year: "Год",
    km_age: "Пробег, км",
    color: "Цвет",
    wheel: "Руль",
    vin: "VIN",
    pts: "ПТС",
    owners_count: "Владельцев",
    section: "Раздел",
    condition: "Состояние",
    in_stock: "Наличие",
    custom: "Таможня/кастом",
    seller: "Продавец",
    address: "Адрес",
    region: "Регион",
    city: "Город",
    offer_updated_at: "Обновлено",
    options: "Опции",
    engine_type: "Двигатель",
    displacement: "Объём, л",
    horse_power: "Л.с.",
    body_type: "Кузов",
    transmission: "Коробка",
    drive_type: "Привод",
    no_accidents: "Без ДТП",
    seller_url: "Ссылка продавца",
  };

  const VALUE_MAP = {
    section: { NEW: "Новая", USED: "С пробегом" },
    in_stock: { IN_STOCK: "В наличии", OUT_OF_STOCK: "Нет в наличии" },
    no_accidents: { TRUE: "Да", FALSE: "Нет", true:"Да", false:"Нет" },
    wheel: { left:"Левый", right:"Правый" },
  };

  function translateValue(key, val){
    if(val===undefined || val===null) return null;
    const s = String(val).trim();
    if(!s) return null;
    const map = VALUE_MAP[key];
    if(map){
      const hit = map[s] ?? map[s.toUpperCase()] ?? map[s.toLowerCase()];
      if(hit) return hit;
    }
    return s;
  }

  /* ======================================================================
     DOMAIN: REGIONS РФ + МОСКВА (округа/районы) + жёсткая валидация
  ====================================================================== */
  const REGIONS = [
    "Алтайский край","Амурская область","Архангельская область","Астраханская область",
    "Белгородская область","Брянская область","Владимирская область","Волгоградская область",
    "Вологодская область","Воронежская область","Донецкая Народная Республика",
    "Еврейская автономная область","Забайкальский край","Запорожская область",
    "Ивановская область","Иркутская область","Кабардино-Балкарская Республика",
    "Калининградская область","Калужская область","Камчатский край",
    "Карачаево-Черкесская Республика","Кемеровская область — Кузбасс","Кировская область",
    "Костромская область","Краснодарский край","Красноярский край","Курганская область",
    "Курская область","Ленинградская область","Липецкая область","Луганская Народная Республика",
    "Магаданская область","Москва","Московская область","Мурманская область",
    "Ненецкий автономный округ","Нижегородская область","Новгородская область",
    "Новосибирская область","Омская область","Оренбургская область","Орловская область",
    "Пензенская область","Пермский край","Приморский край","Псковская область",
    "Республика Адыгея","Республика Алтай","Республика Башкортостан","Республика Бурятия",
    "Республика Дагестан","Республика Ингушетия","Республика Калмыкия","Республика Карелия",
    "Республика Коми","Республика Крым","Республика Марий Эл","Республика Мордовия",
    "Республика Саха (Якутия)","Республика Северная Осетия — Алания","Республика Татарстан",
    "Республика Тыва","Республика Хакасия","Ростовская область","Рязанская область",
    "Самарская область","Санкт-Петербург","Саратовская область","Сахалинская область",
    "Свердловская область","Севастополь","Смоленская область","Ставропольский край",
    "Тамбовская область","Тверская область","Томская область","Тульская область",
    "Тюменская область","Удмуртская Республика","Ульяновская область",
    "Хабаровский край","Ханты-Мансийский автономный округ — Югра","Херсонская область",
    "Челябинская область","Чеченская Республика","Чувашская Республика",
    "Чукотский автономный округ","Ямало-Ненецкий автономный округ","Ярославская область"
  ];

  const REGION_ALIASES = {
    "спб":"санкт-петербург","питер":"санкт-петербург",
    "краснодар":"краснодарский край","краснодарский":"краснодарский край",
    "москва":"москва","московская":"московская область",
    "ленинградская":"ленинградская область","югра":"ханты-мансийский автономный округ — югра",
    "якутия":"республика саха (якутия)"
  };

  const MOSCOW_AO = [
    { group:"ЦАО", items:["Арбат","Басманный","Замоскворечье","Красносельский","Мещанский","Пресненский","Таганский","Тверской","Хамовники","Якиманка"]},
    { group:"САО", items:["Аэропорт","Беговой","Бескудниковский","Войковский","Восточное Дегунино","Головинский","Дмитровский","Западное Дегунино","Коптево","Левобережный","Молжаниновский","Савёловский","Сокол","Тимирязевский","Ховрино","Хорошёвский"]},
    { group:"СВАО", items:["Алексеевский","Алтуфьевский","Бабушкинский","Бибирево","Бутырский","Лианозово","Лосиноостровский","Марфино","Марьина Роща","Останкинский","Отрадное","Ростокино","Свиблово","Северное Медведково","Южное Медведково","Северный","Ярославский"]},
    { group:"ВАО", items:["Богородское","Вешняки","Восточный","Гольяново","Ивановское","Измайлово","Косино-Ухтомский","Метрогородок","Новогиреево","Новокосино","Перово","Преображенское","Северное Измайлово","Соколиная Гора","Сокольники"]},
    { group:"ЮВАО", items:["Выхино-Жулебино","Капотня","Кузьминки","Лефортово","Люблино","Марьино","Некрасовка","Нижегородский","Печатники","Рязанский","Текстильщики","Южнопортовый"]},
    { group:"ЮАО", items:["Бирюлёво Восточное","Бирюлёво Западное","Братеево","Даниловский","Донской","Зябликово","Москворечье-Сабурово","Нагатино-Садовники","Нагатинский Затон","Нагорный","Орехово-Борисово Северное","Орехово-Борисово Южное","Царицыно","Чертаново Северное","Чертаново Центральное","Чертаново Южное"]},
    { group:"ЮЗАО", items:["Академический","Гагаринский","Зюзино","Коньково","Котловка","Ломоносовский","Обручевский","Северное Бутово","Южное Бутово","Тёплый Стан","Черёмушки","Ясенево"]},
    { group:"ЗАО", items:["Внуково","Дорогомилово","Крылатское","Кунцево","Можайский","Ново-Переделкино","Очаково-Матвеевское","Проспект Вернадского","Раменки","Солнцево","Тропарёво-Никулино","Филёвский Парк","Фили-Давыдково"]},
    { group:"СЗАО", items:["Куркино","Митино","Покровское-Стрешнево","Северное Тушино","Строгино","Хорошёво-Мнёвники","Щукино","Южное Тушино"]},
    { group:"ЗелАО", items:["Крюково","Матушкино","Савёлки","Силино","Старое Крюково"]},
    { group:"ТиНАО", items:["Внуковское","Воскресенское","Десёновское","Кокошкино","Марушкинское","Мосрентген","Рязановское","Сосенское","Филимонковское","Щербинка","Троицк","Первомайское","Новофёдоровское","Киевский"]},
  ];
  const MOSCOW_DISTRICTS = MOSCOW_AO.flatMap(g => g.items);

  function normalizeRegion(s){
    return String(s||"")
      .toLowerCase()
      .replace(/ё/g,"е")
      .replace(/[.\-,]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }

  function matchRfRegion(raw){
    const n = normalizeRegion(raw);
    if(!n) return null;
    if(REGION_ALIASES[n]){
      const aliasNorm = REGION_ALIASES[n];
      return REGIONS.find(r => normalizeRegion(r) === aliasNorm) || null;
    }
    return REGIONS.find(r => normalizeRegion(r) === n) || null;
  }

  function matchMoscowDistrict(raw){
    const n = normalizeRegion(raw);
    if(!n) return null;
    const AO_ALIASES = {
      "ювао":true,"цао":true,"сао":true,"свао":true,"вао":true,
      "юао":true,"юзао":true,"зао":true,"сзао":true,"зелао":true,"тинао":true,
    };
    if(AO_ALIASES[n]) return null; // AO — только группировка, не регион
    return MOSCOW_DISTRICTS.find(d => normalizeRegion(d) === n) || null;
  }

  function matchRegion(raw){
    const moscow = matchMoscowDistrict(raw);
    if(moscow) return moscow;
    const rf = matchRfRegion(raw);
    if(rf) return rf;
    return null;
  }

  function buildGroupedRegions(baseCars){
    const availableMoscow = new Set();
    const availableRf = new Set();

    baseCars.forEach(c=>{
      if(!c.region) return;
      const norm = normalizeRegion(c.region);
      if(MOSCOW_DISTRICTS.some(d => normalizeRegion(d) === norm)){
        availableMoscow.add(norm); return;
      }
      if(REGIONS.some(r => normalizeRegion(r) === norm)){
        availableRf.add(norm); return;
      }
    });

    const groups = [];

    if(availableMoscow.size){
      MOSCOW_AO.forEach(g=>{
        const items = g.items
          .filter(name => availableMoscow.has(normalizeRegion(name)))
          .map(name => ({ value: normalizeRegion(name), label: name }));
        if(items.length) groups.push({ group: g.group, items });
      });
    }

    if(availableRf.size){
      const rfItems = REGIONS
        .filter(name => availableRf.has(normalizeRegion(name)))
        .map(name => ({ value: normalizeRegion(name), label: name }));
      if(rfItems.length) groups.push({ group: "Регионы РФ", items: rfItems });
    }

    return groups;
  }

  function isValidYear(value){
    const s = String(value ?? "").trim();
    if(!/^\d{4}$/.test(s)) return false;
    const y = Number(s);
    const max = new Date().getFullYear() + 1;
    return y >= 1900 && y <= max;
  }

  /* ======================================================================
     DOMAIN: SELLER DETECT
  ====================================================================== */
  const DEALER_KEYWORDS = [
    "рольф","major","авилон","avilon","fresh","inchcape","ттс","expocar",
    "автосалон","автосервис","дилер","dealer","trade-in","трейд-ин",
    "group","групп","мотors","motors","auto","авто","центр",
    "carprice","car price","select","selection","prime","premium"
  ];
  function looksLikePersonName(s){
    if(!s) return false;
    const t = s.trim();
    if(/\b(ооо|оао|зао|пао|ип|ao|llc|inc|групп|group|авто|motors|dealer|дилер)\b/i.test(t)) return false;
    const words = t.split(/\s+/).filter(Boolean);
    if(words.length < 2 || words.length > 3) return false;
    return words.every(w => /^[А-ЯЁ][а-яё\-]+$/.test(w));
  }
  function normalizeSellerType(sellerRaw){
    const s = (sellerRaw||"").toString().toLowerCase().replace(/ё/g,"е");
    if(!s.trim()) return null;
    if(DEALER_KEYWORDS.some(k => s.includes(k))) return "dealer";
    if(looksLikePersonName(sellerRaw)) return "owner";
    return null;
  }

  /* ======================================================================
     STATE + ELEMENTS
  ====================================================================== */
  const state = {
    allCarsActive: [],
    allCarsRemoved: [],
    filtered: [],
    condition: "all",
    status: "active",
    filters: { mark:null, model:null, year:null, color:null, region:null, seller:"all" },
    lastSignatures: { active:null, removed:null },
    lastRenderKind: "active",
    isBooted: false,
    hasShown: false,
  };

  const elements = {
    root: document.querySelector("[data-cars-root]"),
    tabsCondition: [...document.querySelectorAll("[data-condition]")],
    tabsStatus:    [...document.querySelectorAll("[data-status]")],
    tabsSeller:    [...document.querySelectorAll("[data-seller]")],
    selectMark:   document.getElementById("filterMark"),
    selectModel:  document.getElementById("filterModel"),
    selectYear:   document.getElementById("filterYear"),
    selectColor:  document.getElementById("filterColor"),
    selectRegion: document.getElementById("filterRegion"),
    resetBtn:     document.getElementById("carsReset"),
    showBtn:      document.getElementById("carsShow"),
    loader:       document.getElementById("carsLoader"),
    grid:         document.getElementById("carsGrid"),
    fields:       [...document.querySelectorAll(".cars-field")],
    modal:        document.getElementById("carsModal"),
    modalTitle:   document.getElementById("carsModalTitle"),
    modalMedia:   document.getElementById("carsModalMedia"),
    modalPrice:   document.getElementById("carsModalPrice"),
    modalSub:     document.getElementById("carsModalSub"),
    modalList:    document.getElementById("carsModalList"),
    modalLink:    document.getElementById("carsModalLink"),
  };

  function showLoader(ms=2000){
    if(!elements.loader) return;
    elements.loader.classList.add("is-on");
    elements.loader.setAttribute("aria-hidden","false");
    setTimeout(()=>{
      elements.loader.classList.remove("is-on");
      elements.loader.setAttribute("aria-hidden","true");
    }, ms);
  }

  /* ======================================================================
     DOMAIN: CLEAN / PARSE / DEDUPE
  ====================================================================== */
  function cleanValue(v){
    if (v===undefined||v===null) return null;
    const s=String(v).trim(); if(!s) return null;
    const l=s.toLowerCase();
    if(["nan","null","undefined"].includes(l)) return null;
    return s;
  }
  function normalizeLower(v){ const c=cleanValue(v); return c?c.toLowerCase():null; }
  function parseNumber(value){
    const digits = cleanValue(value)?.replace(/[^0-9-]/g,"");
    if(!digits) return null;
    const n=Number(digits); return Number.isFinite(n)?n:null;
  }
  function parseDate(value){
    const v=cleanValue(value); if(!v) return null;
    const d=new Date(v); return Number.isFinite(d.getTime())?d:null;
  }
  function detectDelimiter(text){
    const first=text.split(/\r?\n/)[0]||"";
    const sc=(first.match(/;/g)||[]).length;
    const cc=(first.match(/,/g)||[]).length;
    if(sc>cc) return ";";
    if(cc>sc) return ",";
    return ";";
  }
  function parseCSV(text){
    const delimiter=detectDelimiter(text);
    const lines=text.split(/\r?\n/).filter(l=>l.trim()!=="");
    if(!lines.length) return [];
    const header=lines.shift().split(delimiter).map(h=>h.trim());
    return lines.map(line=>{
      const cells=line.split(delimiter);
      const row={};
      header.forEach((k,i)=> row[k]=cells[i]??"");
      return row;
    });
  }
  function getFirstImage(urls){
    const val=cleanValue(urls); if(!val) return null;
    const parts=val.split(/\s*\|\s*|\s*,\s*/).filter(Boolean);
    return parts[0]||null;
  }

  function buildCar(row, kind, fileIndex){
    const mark=cleanValue(row.mark);
    const model=cleanValue(row.model);

    const rawYear=parseNumber(row.year);
    const year=(rawYear && isValidYear(rawYear)) ? rawYear : null;

    const color=cleanValue(row.color);

    const regionMatched = matchRegion(row.region || row.city || "");
    const region = regionMatched || null;

    const city=cleanValue(row.city);
    const kmAge=parseNumber(row.km_age);

    const sellerName = cleanValue(row.seller);
    const sellerType = normalizeSellerType(sellerName);
    const sellerId   = cleanValue(row.seller_id);

    const priceValue=parseNumber(row.price_rub);
    const priceText=priceValue
      ? new Intl.NumberFormat("ru-RU").format(priceValue)+" ₽"
      : cleanValue(row.price_rub);

    const updatedAt=parseDate(row.offer_updated_at || row.updated_at);
    const url=cleanValue(row.url);
    const image=getFirstImage(row.image_urls);
    const condition=kmAge>0 ? "used" : "new";

    const dedupeKey = url || [
      normalizeLower(mark)||"",
      normalizeLower(model)||"",
      year||"",
      priceValue||"",
      normalizeLower(region)||"",
      normalizeLower(city)||"",
      kmAge||""
    ].join("|");

    return {
      raw: row, kind, fileIndex, dedupeKey, updatedAt,
      id: cleanValue(row.id),
      innerId: cleanValue(row.inner_id),
      sellerId,
      sellerName,
      sellerType,
      mark, markNorm: normalizeLower(mark),
      model, modelNorm: normalizeLower(model),
      year,
      color, colorNorm: normalizeLower(color),
      region, regionNorm: normalizeLower(region),
      city, kmAge, condition,
      priceValue, priceText,
      bodyType: cleanValue(row.body_type),
      generation: cleanValue(row.generation),
      configuration: cleanValue(row.configuration),
      complectation: cleanValue(row.complectation),
      engineType: cleanValue(row.engine_type),
      displacement: cleanValue(row.displacement),
      horsePower: cleanValue(row.horse_power),
      transmission: cleanValue(row.transmission),
      driveType: cleanValue(row.drive_type),
      noAccidents: cleanValue(row.no_accidents),
      wheel: cleanValue(row.wheel),
      vin: cleanValue(row.vin),
      ownersCount: cleanValue(row.owners_count),
      section: cleanValue(row.section),
      inStock: cleanValue(row.in_stock),
      custom: cleanValue(row.custom),
      address: cleanValue(row.address),
      sellerUrl: cleanValue(row.seller_url),
      image, url,
    };
  }

  function signatureFromText(texts){
    let acc=0;
    texts.forEach(t=>{
      for(let i=0;i<t.length;i++){
        acc=(acc*31+t.charCodeAt(i))>>>0;
      }
      acc=(acc^t.length)>>>0;
    });
    return String(acc);
  }

  function dedupeCars(cars){
    const map=new Map();
    cars.forEach(car=>{
      if(!car.url) return;
      const ex=map.get(car.dedupeKey);
      if(!ex){ map.set(car.dedupeKey,car); return; }
      if(car.updatedAt && ex.updatedAt){
        if(car.updatedAt>ex.updatedAt) map.set(car.dedupeKey,car);
        return;
      }
      if(car.updatedAt && !ex.updatedAt){ map.set(car.dedupeKey,car); return; }
      if(!car.updatedAt && !ex.updatedAt){
        if(car.fileIndex>=ex.fileIndex) map.set(car.dedupeKey,car);
      }
    });
    return [...map.values()];
  }

  /* ======================================================================
     DATA LOADING
  ====================================================================== */
  async function fetchCsvSafe(url){
    try{
      const r=await fetch(url,{cache:"no-store"});
      if(!r.ok) return null;
      return await r.text();
    }catch{ return null; }
  }

  async function loadCarsKind(kind){
    const urls=CSV_SOURCES[kind]||[];
    const texts=[];
    for(let i=0;i<urls.length;i++){
      const url=urls[i];
      const text=await fetchCsvSafe(url);
      if(text) texts.push({url,text,fileIndex:i});
    }
    const signature=signatureFromText(texts.map(x=>x.text));
    const cars=texts.flatMap(({text,fileIndex}) =>
      parseCSV(text).map(row=>buildCar(row,kind,fileIndex))
    );
    return { cars: dedupeCars(cars), signature };
  }

  async function initialLoadAll(){
    showLoader(2000);
    const active=await loadCarsKind("active");
    const removed=await loadCarsKind("removed");

    state.allCarsActive=active.cars;
    state.allCarsRemoved=removed.cars;
    state.lastSignatures.active=active.signature;
    state.lastSignatures.removed=removed.signature;

    state.isBooted=true;
    updateAll();
  }

  async function syncIfChanged(kind){
    const res=await loadCarsKind(kind);
    if(res.signature===state.lastSignatures[kind]) return false;
    state.lastSignatures[kind]=res.signature;
    if(kind==="active") state.allCarsActive=res.cars;
    else state.allCarsRemoved=res.cars;
    return true;
  }

  function startHourlySync(){
    setInterval(async ()=>{
      const a=await syncIfChanged("active");
      const r=await syncIfChanged("removed");
      if((a||r) && state.lastRenderKind===state.status){
        updateAll(false);
      }
    }, UPDATE_INTERVAL_MS);
  }

  /* ======================================================================
     FILTERS / OPTIONS
  ====================================================================== */
  function uniqOptions(cars,key,displayKey=key){
    const map=new Map();
    cars.forEach(car=>{
      const norm=car[`${key}Norm`];
      if(!norm) return;
      if(!map.has(norm)){
        map.set(norm, car[displayKey]||car[key]||"");
      }
    });
    return [...map.entries()].map(([value,label])=>({value,label}));
  }

  function uniqYears(cars){
    const set=new Set();
    cars.forEach(c=>{
      if(c.year && isValidYear(c.year)) set.add(c.year);
    });
    return [...set].sort((a,b)=>b-a).map(y=>({value:String(y),label:String(y)}));
  }

  function applyFilters(cars,current){
    return cars.filter(car=>{
      if(!car.url) return false;
      if(current.condition!=="all" && car.condition!==current.condition) return false;

      if(current.filters.seller && current.filters.seller!=="all"){
        if(car.sellerType !== current.filters.seller) return false;
      }

      if(current.filters.mark && car.markNorm!==current.filters.mark) return false;
      if(current.filters.model && car.modelNorm!==current.filters.model) return false;
      if(current.filters.year && String(car.year)!==current.filters.year) return false;
      if(current.filters.color && car.colorNorm!==current.filters.color) return false;
      if(current.filters.region && car.regionNorm!==current.filters.region) return false;
      return true;
    });
  }

  function filteredExcept(baseCars,key){
    const copy={
      condition: state.condition,
      status: state.status,
      filters: {...state.filters},
    };
    copy.filters[key]=null;
    return applyFilters(baseCars,copy);
  }

  function renderOptions(select, options){
    select.innerHTML="";
    const empty=document.createElement("option");
    empty.value=""; empty.textContent=""; empty.disabled=true; empty.hidden=true;
    select.appendChild(empty);

    options.forEach(opt=>{
      const o=document.createElement("option");
      o.value=opt.value; o.textContent=opt.label;
      select.appendChild(o);
    });

    const current=state.filters[select.dataset.key];
    select.value=current||"";
  }

  function renderGroupedRegionSelect(select, grouped){
    select.innerHTML="";
    const empty=document.createElement("option");
    empty.value=""; empty.textContent=""; empty.disabled=true; empty.hidden=true;
    select.appendChild(empty);

    grouped.forEach(g=>{
      const og=document.createElement("optgroup");
      og.label=g.group;
      g.items.forEach(opt=>{
        const o=document.createElement("option");
        o.value=opt.value;
        o.textContent=opt.label;
        og.appendChild(o);
      });
      select.appendChild(og);
    });

    select.value = state.filters.region || "";
  }

  function updateOptions(baseCars){
    const marks=uniqOptions(filteredExcept(baseCars,"mark"),"mark")
      .sort((a,b)=>a.label.localeCompare(b.label,"ru"));
    const models=uniqOptions(filteredExcept(baseCars,"model"),"model")
      .sort((a,b)=>a.label.localeCompare(b.label,"ru"));
    const years=uniqYears(filteredExcept(baseCars,"year"));
    const colors=uniqOptions(filteredExcept(baseCars,"color"),"color")
      .sort((a,b)=>a.label.localeCompare(b.label,"ru"));

    const groupedRegions = buildGroupedRegions(filteredExcept(baseCars,"region"));

    const selects=new Map([
      ["mark",marks],["model",models],["year",years],["color",colors]
    ]);

    let invalid=false;
    for(const [key,opts] of selects.entries()){
      const current=state.filters[key];
      if(current && !opts.some(o=>o.value===current)){
        state.filters[key]=null; invalid=true;
      }
    }

    if(state.filters.region){
      const flat = groupedRegions.flatMap(g=>g.items||[]);
      if(!flat.some(o=>o.value===state.filters.region)){
        state.filters.region=null; invalid=true;
      }
    }
    if(invalid) return true;

    elements.selectMark.dataset.key="mark";
    elements.selectModel.dataset.key="model";
    elements.selectYear.dataset.key="year";
    elements.selectColor.dataset.key="color";
    elements.selectRegion.dataset.key="region";

    renderOptions(elements.selectMark, marks);
    renderOptions(elements.selectModel, models);
    renderOptions(elements.selectYear, years);
    renderOptions(elements.selectColor, colors);
    renderGroupedRegionSelect(elements.selectRegion, groupedRegions);

    elements.selectModel.disabled = !state.filters.mark;
    return false;
  }

  function updateCounts(filtered){
    const n=filtered.length;
    elements.showBtn.textContent=`Найдено ${n} объявлений`;
    elements.showBtn.disabled=n===0;
  }

  function syncFieldCapsules(){
    elements.fields.forEach(field=>{
      const select=field.querySelector("select");
      field.classList.toggle("has-value", Boolean(select?.value));
    });
  }

  /* ======================================================================
     RENDER CARDS
  ====================================================================== */
  function buildCardMain(car){
    const bits=[];
    if(car.mark) bits.push(car.mark);
    if(car.model) bits.push(car.model);
    if(car.year) bits.push(car.year);
    if(car.color) bits.push(car.color);
    return bits.join(" ");
  }

  function buildCardSub(car){
    const bits=[];
    if(car.kmAge!==null && car.kmAge!==undefined){
      bits.push(`${new Intl.NumberFormat("ru-RU").format(car.kmAge)} км`);
    }
    const body=[car.complectation,car.generation].filter(Boolean).join(" / ");
    if(body) bits.push(body);
    const location=[car.region,car.city].filter(Boolean).join(", ");
    if(location) bits.push(location);
    return bits.join(" · ");
  }

  function renderCards(filtered){
    elements.grid.innerHTML="";
    if(!filtered.length){
      elements.grid.innerHTML='<div class="ty-body cars-empty">Нет объявлений</div>';
      return;
    }
    filtered.forEach(car=>{
      const card=document.createElement("article");
      card.className="cars-card cars-smoke";
      card.dataset.key=car.dedupeKey;

      const title=document.createElement("div");
      title.className="cars-card-title";
      title.textContent=buildCardMain(car);

      const sub=document.createElement("div");
      sub.className="cars-card-sub";
      sub.textContent=buildCardSub(car);

      card.appendChild(title);
      card.appendChild(sub);
      card.addEventListener("click",()=>openModal(car));
      elements.grid.appendChild(card);
    });
  }

  /* ======================================================================
     MODAL
  ====================================================================== */
  function buildModalSub(car){
    const bits=[];
    if(car.year) bits.push(car.year);
    if(car.kmAge!==null && car.kmAge!==undefined){
      bits.push(`${new Intl.NumberFormat("ru-RU").format(car.kmAge)} км`);
    }
    const body=[car.bodyType,car.generation,car.complectation].filter(Boolean).join(" / ");
    if(body) bits.push(body);
    const loc=[car.region,car.city].filter(Boolean).join(", ");
    if(loc) bits.push(loc);
    return bits.join(" · ");
  }

  function buildDetailsList(car){
    const items=[];
    Object.entries(car.raw).forEach(([k,v])=>{
      if(EXCLUDED_DETAILS.has(k)) return;
      const c=cleanValue(v);
      if(!c) return;
      const label = FIELD_LABELS_RU[k] || k;
      const valRu = translateValue(k, c);
      items.push([label, valRu]);
    });
    if(car.sellerId) items.push(["ID аккаунта", car.sellerId]);
    return items;
  }

  function openModal(car){
    elements.modalTitle.textContent=buildCardMain(car);
    elements.modalPrice.textContent=car.priceText||"";
    elements.modalSub.textContent=buildModalSub(car);

    elements.modalMedia.innerHTML="";
    if(car.image){
      const img=document.createElement("img");
      img.src=car.image;
      img.alt=elements.modalTitle.textContent;
      elements.modalMedia.appendChild(img);
    }

    elements.modalList.innerHTML="";
    buildDetailsList(car).forEach(([label,val])=>{
      const li=document.createElement("li");
      li.textContent=`${label}: ${val}`;
      elements.modalList.appendChild(li);
    });

    if(car.url){
      elements.modalLink.href=car.url;
      elements.modalLink.style.display="";
    } else {
      elements.modalLink.removeAttribute("href");
      elements.modalLink.style.display="none";
    }

    elements.modal.classList.add("is-open");
    elements.modal.setAttribute("aria-hidden","false");
    document.body.style.overflow="hidden";
  }

  function closeModal(){
    elements.modal.classList.remove("is-open");
    elements.modal.setAttribute("aria-hidden","true");
    document.body.style.overflow="";
  }

  elements.modal.addEventListener("click",(e)=>{
    if(e.target.closest("[data-modal-close]")) closeModal();
  });
  window.addEventListener("keydown",(e)=>{
    if(e.key==="Escape" && elements.modal.classList.contains("is-open")) closeModal();
  });

  /* ======================================================================
     UPDATE FLOW
  ====================================================================== */
  function updateAll(clearCards=true){
    const baseCars = state.status==="active" ? state.allCarsActive : state.allCarsRemoved;
    const filtered = applyFilters(baseCars, state);
    state.filtered = filtered;
    state.lastRenderKind = state.status;

    const needsRecalc = updateOptions(baseCars);
    if(needsRecalc){ updateAll(clearCards); return; }

    updateCounts(filtered);
    syncFieldCapsules();

    if(state.hasShown){
      renderCards(filtered);
      return;
    }

    if(clearCards) elements.grid.innerHTML="";
  }

  /* ======================================================================
     BINDINGS
  ====================================================================== */
  function bindTabs(){
    elements.tabsCondition.forEach(btn=>{
      btn.addEventListener("click",()=>{
        if(btn.getAttribute("aria-pressed")==="true") return;
        elements.tabsCondition.forEach(b=>b.setAttribute("aria-pressed","false"));
        btn.setAttribute("aria-pressed","true");
        state.condition=btn.dataset.condition;
        updateAll();
      });
    });

    elements.tabsStatus.forEach(btn=>{
      btn.addEventListener("click",()=>{
        if(btn.getAttribute("aria-pressed")==="true") return;
        elements.tabsStatus.forEach(b=>b.setAttribute("aria-pressed","false"));
        btn.setAttribute("aria-pressed","true");
        state.status=btn.dataset.status;

        showLoader(2000);

        updateAll();
      });
    });

    elements.tabsSeller.forEach(btn=>{
      btn.addEventListener("click",()=>{
        if(btn.getAttribute("aria-pressed")==="true") return;
        elements.tabsSeller.forEach(b=>b.setAttribute("aria-pressed","false"));
        btn.setAttribute("aria-pressed","true");
        state.filters.seller = btn.dataset.seller;
        updateAll();
      });
    });
  }

  function bindSelects(){
    [elements.selectMark,elements.selectModel,elements.selectYear,elements.selectColor,elements.selectRegion]
      .forEach(select=>{
        select.addEventListener("change",()=>{
          const key=select.dataset.key;
          state.filters[key]=select.value || null;
          if(key==="mark") state.filters.model=null;
          updateAll();
          syncFieldCapsules();
        });
      });
  }

  function bindActions(){
    elements.resetBtn.addEventListener("click",()=>{
      state.condition="all";
      state.status="active";
      state.filters={mark:null,model:null,year:null,color:null,region:null,seller:"all"};
      state.hasShown=false;

      elements.tabsCondition.forEach(btn=>
        btn.setAttribute("aria-pressed", btn.dataset.condition==="all" ? "true":"false")
      );
      elements.tabsStatus.forEach(btn=>
        btn.setAttribute("aria-pressed", btn.dataset.status==="active" ? "true":"false")
      );
      elements.tabsSeller.forEach(btn=>
        btn.setAttribute("aria-pressed", btn.dataset.seller==="all" ? "true":"false")
      );

      updateAll(true);
    });

    elements.showBtn.addEventListener("click",()=>{
      if(!state.filtered.length) return;
      state.hasShown = true;
      renderCards(state.filtered);
    });
  }

  /* ======================================================================
     BOOT
  ====================================================================== */
  if(!state.isBooted){
    initialLoadAll();
    bindTabs();
    bindSelects();
    bindActions();
    startHourlySync();
  }
  </script>
</section>
