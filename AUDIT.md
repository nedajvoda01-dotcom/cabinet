# Repository Audit (Step 1)

## Boundary violations (P0/P1/P2)
- **P0 – Business logic in adapter — RESOLVED**: Parser photo ingestion orchestration was pulled out of `backend/src/Adapters/ParserAdapter.php` into `backend/src/Application/Services/RawPhotosIngestService.php` (order naming + orchestration) backed by a thin IO port `backend/src/Application/Ports/PhotosIngestPort.php` and infrastructure adapter `backend/src/Adapters/PhotosIngestAdapter.php`. ParserAdapter now only normalizes/polls/acks, delegating ingestion through the service; ParserWorker consumes the service so the adapter remains translation-only.【F:backend/src/Adapters/ParserAdapter.php†L9-L67】【F:backend/src/Application/Services/RawPhotosIngestService.php†L1-L53】【F:backend/src/Workers/ParserWorker.php†L12-L63】【F:backend/src/Adapters/PhotosIngestAdapter.php†L1-L39】
- **P1 – Frozen tree missing required doc/infra nodes** — Expected `docs/`, `infra/`, `.github/workflows`, and other root files from the frozen structure are absent, so repository layout diverges from AGENTS.md. Add the missing directories/files (even as stubs) to match the mandated tree.【F:AGENTS.md†L39-L150】【01b54d†L1-L3】
- **P1 – Source-of-truth Spec** — **Resolved**: Autocontent spec is present in the repo, enabling alignment of implementations/tests with the declared source of truth.

## Gaps vs Autocontent Spec (per module/worker)
- **Parser module** — Dispatch now flows through the pipeline with trace/idempotency seeding, but retry/DLQ semantics and WS emission coverage remain TODO per Spec.【F:backend/src/Modules/Parser/ParserJobs.php†L12-L52】【F:backend/src/Application/Pipeline/Jobs/Job.php†L21-L55】
- **Export module** — Pipeline states are limited to a short list and stop at `done/failed/canceled`; no explicit retry/DLQ states, no correlation_id propagation, and no WS events around long-running export stages. `ExportJobs` wiring exists but async execution, retries, and DLQ aren’t covered.【F:backend/src/Modules/Export/ExportService.php†L18-L100】【F:backend/src/Modules/Export/ExportJobs.php†L12-L44】
- **Publish module** — Dispatch now uses the pipeline but still lacks explicit retry/DLQ/WS coverage, so publish worker flows need Spec-driven state transitions and observability layers.【F:backend/src/Modules/Publish/PublishJobs.php†L12-L58】【F:backend/src/Workers/PublishWorker.php†L71-L129】
- **Photos module** — Dispatch is normalized through the pipeline, yet downstream worker semantics (retry/DLQ/WS) and schema coverage remain TODO.【F:backend/src/Modules/Photos/PhotosJobs.php†L12-L58】
- **Robot/Publish worker loop** — `RobotService` handles attempts and status sync but lacks WS emissions and explicit DLQ/retry integration hooks for worker failures; external session lifecycle errors only update DB without queue policies or Spec-driven state transitions. Robot status requeues now flow through the pipeline for trace/idempotency consistency.【F:backend/src/Modules/Robot/RobotService.php†L15-L118】【F:backend/src/Workers/RobotStatusWorker.php†L70-L118】
- **Cross-cutting** — No WS event matrix or schema validation is present for modules; validation relies on DTO parsing without schemas tied to Spec. Add validation schemas for request/response and WS payloads across modules in line with Autocontent Spec requirements.【F:AGENTS.md†L25-L36】

## Test gaps
- There are no unit/integration/e2e tests covering Robot flows, WS events, DLQ/retry semantics, or queue adapters; existing suites only touch parser/photos/export/publish happy paths. Add tests that exercise retries, DLQ routing, WS notifications, and Robot publish status sync per Spec across unit/integration/e2e layers.【db0085†L1-L16】
- No structural/tests enforcement for frozen tree or boundary linting is present; CI expectations in AGENTS.md (lint + boundary-lint) aren’t represented, risking unnoticed violations. Add boundary/lint tests or CI checks to enforce the mandated structure and dependencies.【F:AGENTS.md†L192-L200】【01b54d†L1-L3】

## Quick wins (≤1h)
- Quick wins tracked in Layers 1–3 are completed (frozen-tree placeholders, spec availability, queue dispatch stubs replaced with real wiring).

## Architecture guardrails (per AGENT.md / AGENT1.md)
- The system is explicitly an Execution Platform / Conveyor: the backend is a safe, blind execution conveyor that orchestrates jobs, retries, locks, and observability but does not “understand” external domains; all intelligence resides in external executors/parsers/analytics.
- Blind core, external intelligence: core services must remain neutral and avoid vendor/source semantics; decision-making and domain-specific logic live in integrations behind ports/adapters.
- Migration is strictly incremental: every change must move the codebase closer to the target conveyor architecture without a big-bang rewrite, preserving current behavior while improving structure.
- Any code that cannot meet the target architecture must be relocated to `_legacy/` rather than coexisting in active paths.
- Codex must halt work and report if a requested change would violate AGENT.md/AGENT1.md rules, treating architecture breaches as merge-blocking.
- `_legacy/` is the only permitted quarantine for architectural violations. The following violations require relocation into `_legacy/`: business logic inside adapters; orchestration that escapes pipeline/drivers; and any vendor/source semantics leaking into core layers above adapters. New code in `_legacy/` is forbidden—only isolating existing violations is allowed. Enforcements added: boundary unit test asserts `_legacy` folders exist and fail when non-legacy code imports/includes `_legacy`, making violations visible in CI/review.

## Normalized contract primitives and trace enforcement (Step 3)
- Introduced `backend/src/Application/Contracts/{Status.php,ErrorKind.php,Error.php,TraceContext.php}` as the normalized outcome/error/trace language for the conveyor. These primitives standardize status vocabulary, classify errors (transient/permanent/auth/rate_limit/bad_input/conflict/not_found/unknown), and attach a trace context to every error payload. They are not a business-rule layer; they only provide normalized containers for outcomes and observability.
- Added `TraceIdMiddleware` to generate a `traceId` when missing, attach it to the request context, emit it via `X-Trace-Id`, and seed the global `TraceContext` used by contract objects. Error helpers in auth/role middlewares now emit normalized `Error` payloads with `traceId` populated, and all schema `fail()` helpers in modules now include the current `traceId`.
- Queue payloads now automatically receive `trace_id` via `TraceContext::ensure()` to keep worker/job executions traceable without altering business logic.
- PHPUnit is declared as a dev dependency (composer-based) and a minimal unit test asserts trace propagation and error shapes. Composer installation may require network access; CI should run `composer install` to make the suite runnable.

## Pipeline skeleton and pilot wiring (Step 5)
- Seeded the conveyor pipeline core under `backend/src/Application/Pipeline/` with value objects for jobs (`Jobs/Job.php`, `Jobs/JobPayload.php`, `Jobs/JobType.php`), retry classification (`Retry/ErrorClassifier.php`, `Retry/RetryPolicy.php`), DLQ record shape (`Dlq/DlqRecord.php`), and event hooks (`Events/PipelineEvent.php`, `Events/EventEmitterInterface.php`, `Events/NullEventEmitter.php`). The focus is reliability primitives: every job now carries `traceId` and `idempotencyKey` via the normalized contract layer.
- Added `JobDispatcher` as a thin enqueue bridge that maps normalized jobs onto existing queue helpers, keeping transport unchanged while enforcing trace/idempotency propagation.
- Piloted the pipeline hook in the Export module only: `ExportJobs` now constructs a normalized `Job` (type, subjectId, payload) and enqueues it through the dispatcher. No business logic moved; only the dispatch path was redirected to the pipeline entrypoint.
- New unit coverage exercises the pipeline seed: job objects always emit trace/idempotency, retry policy respects `ErrorKind` classification, and the Export pilot enqueues with `trace_id` preserved. Tests are runnable via PHPUnit once Composer dependencies are installed in CI.

## Parser ingestion refactor (Step 6)
- Introduced `Application/Ports/PhotosIngestPort.php` to isolate raw photo IO (download + storage) and `Adapters/PhotosIngestAdapter.php` as the infrastructure implementation wrapping existing HTTP + S3 clients.
- Added `Application/Services/RawPhotosIngestService.php` to own ingestion orchestration (ordering, key naming, trace propagation via `TraceContext::ensure`) while delegating IO through the new port.
- `ParserWorker` now depends on the ingestion service and uses it to ingest parser photos; `ParserAdapter` no longer performs download/upload orchestration and remains a thin translation/poll/ack adapter.
- Unit/integration coverage asserts the worker delegates ingestion to the service and that fatal IO errors still surface as before through the worker failure path.

## Pipeline dispatch unification (Step 7)
- All module job dispatchers now route through the conveyor pipeline entrypoint (`JobDispatcher` + normalized `Job`), covering parser, photos, publish, and robot-status paths with consistent trace/idempotency seeding.【F:backend/src/Modules/Parser/ParserJobs.php†L12-L52】【F:backend/src/Modules/Photos/PhotosJobs.php†L12-L58】【F:backend/src/Modules/Publish/PublishJobs.php†L12-L65】【F:backend/src/Workers/RobotStatusWorker.php†L70-L118】
- Workers that re-enqueue background work (publish + robot status) now reuse the pipeline dispatcher instead of calling queue helpers directly, preserving `traceId` and idempotency in retry loops.【F:backend/src/Workers/PublishWorker.php†L71-L130】【F:backend/src/Workers/RobotStatusWorker.php†L70-L118】
- No business logic was moved; only dispatch wiring changed to enforce a single conveyor entry. Queue payload shapes remain intact while gaining normalized trace/idempotency propagation verified by unit tests.【F:tests/unit/backend/jobs.test.php†L8-L86】【F:tests/unit/backend/publishRobotPipeline.test.php†L5-L109】

## Pipeline reliability hardening (Step 8)
- Added operational reliability primitives to the pipeline: backoff-aware retry policy keyed on normalized `ErrorKind`, a DLQ record/writer shape, and an idempotency store interface with in-memory implementation for effectful guards.【F:backend/src/Application/Pipeline/Retry/RetryPolicy.php†L8-L42】【F:backend/src/Application/Pipeline/Dlq/DlqRecord.php†L1-L17】【F:backend/src/Application/Pipeline/Idempotency/InMemoryIdempotencyStore.php†L1-L27】
- PublishWorker is the first worker wired through the reliability handler; job execution is now wrapped with idempotency acquisition, normalized retry decisions, and DLQ writes without altering publish business steps. The handler reuses queue persistence for retry scheduling and writes DLQ records to a pipeline file sink for observability.【F:backend/src/Workers/BaseWorker.php†L29-L63】【F:backend/src/Workers/PublishWorker.php†L15-L134】【F:backend/src/Application/Pipeline/Reliability/ReliabilityHandler.php†L13-L80】【F:backend/src/Application/Pipeline/Dlq/FileDlqWriter.php†L1-L29】
- QueueService now accepts externally computed retry decisions to mark jobs retrying or dead while preserving payload/trace/idempotency; DLQ entries and attempts are recorded without changing module logic.【F:backend/src/Queues/QueueService.php†L87-L171】
- New unit coverage validates retry decisions, DLQ emission, and idempotency suppression of duplicate executions; phpunit remains runnable in CI via composer with no network in this sandbox.【F:tests/unit/backend/pipelineReliability.test.php†L1-L88】
